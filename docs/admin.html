<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calisync Admin Portal</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <style>
        :root{--bg:#0b0c10;--card:#121318;--ink:#e6e6e6;--muted:#9aa0a6;--accent:#6ee7b7;--line:#252732}
        html,body{height:100%}
        body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
        .wrap{max-width:1200px;margin:0 auto;padding:24px;min-height:100vh;display:flex;flex-direction:column;gap:16px}
        .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 2px 24px rgba(0,0,0,.25)}
        .row{display:flex;gap:16px;flex-wrap:wrap}
        .col{flex:1 1 360px}
        h1{font-size:28px;margin:0 0 12px}
        h2{font-size:20px;margin:16px 0 8px}
        h3{font-size:16px;margin:12px 0 6px;color:var(--muted)}
        input,select,button,textarea{background:#0e0f14;border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:10px;font:inherit}
        textarea{min-height:88px;resize:vertical}
        input:focus,select:focus,textarea:focus{outline:1px solid var(--accent)}
        button{cursor:pointer}
        .btn{background:linear-gradient(180deg,#0f172a,#0b1320);border:1px solid #1f2937}
        .btn:hover{filter:brightness(1.1)}
        button:disabled{opacity:.6;cursor:not-allowed}
        .badge{display:inline-flex;align-items:center;gap:6px;background:#0e1a14;border:1px solid #1c2b23;color:#b7f5d8;padding:2px 8px;border-radius:999px;font-size:12px}
        .muted{color:var(--muted)}
        .list{display:flex;flex-direction:column;gap:8px}
        .pill{border-radius:999px;padding:2px 8px;border:1px solid var(--line);color:var(--muted);font-size:12px}
        .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
        .small{font-size:12px}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
        .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
        .stack{display:flex;flex-direction:column;gap:6px}
        .pill-menu{display:flex;gap:8px;flex-wrap:wrap}
        .pill-menu button{border-radius:999px;padding:8px 14px;border:1px solid var(--line);background:transparent;color:var(--ink)}
        .pill-menu button.active{background:var(--accent);color:#04120c;border-color:transparent}
        .section-panel{display:none}
        .section-panel.active{display:block}
        .scroll-area{max-height:320px;overflow:auto;padding-right:4px}
        .toolbar-secondary{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .suggestions{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
        .chip{border:1px solid var(--line);border-radius:999px;padding:4px 10px;background:#0e0f14;cursor:pointer}
        .chip:hover{border-color:var(--accent);color:var(--accent)}
        .day-list{display:flex;flex-direction:column;gap:10px}
        .day-card{border:1px solid var(--line);border-radius:12px;background:#0f1118;padding:12px;box-shadow:0 2px 12px rgba(0,0,0,.18)}
        .day-header{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap}
        .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
        .tag{padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#0c0d12;font-size:12px;color:var(--muted)}
        .tag.accent{background:#0d2219;color:#b7f5d8;border-color:#1c2b23}
        .day-body{display:flex;flex-direction:column;gap:10px;margin-top:10px}
        .inline-actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
        .exercise-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:8px}
        .exercise-item{border:1px solid var(--line);border-radius:12px;background:#0f1118;padding:10px;display:flex;flex-direction:column;gap:6px}
        .exercise-head{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .exercise-head input{flex:1 1 160px;min-width:0}
        .exercise-actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    </style>
</head>
<body>
<div id="app" class="wrap">
    <div v-if="!session" class="card" style="max-width:460px;margin:60px auto;">
        <h1>Calisync Admin Portal</h1>
        <p class="muted">Sign in with your Supabase account to manage trainees, their workout days, and exercises.</p>
        <form @submit.prevent="emailPasswordSignIn" style="display:flex;flex-direction:column;gap:10px;margin-top:12px">
            <input v-model="email" type="email" placeholder="Email" required>
            <input v-model="password" type="password" placeholder="Password" required>
            <button class="btn">Sign in</button>
        </form>
    </div>

    <div v-else>
        <div class="toolbar">
            <div style="display:flex;align-items:center;gap:10px">
                <div class="pill">{{ user?.email }}</div>
                <span class="pill">Admin</span>
            </div>
            <div class="pill-menu">
                <button :class="{active: activeSection==='exercises'}" @click="activeSection='exercises'">Exercises</button>
                <button :class="{active: activeSection==='trainees'}" @click="activeSection='trainees'">Trainees</button>
                <button :class="{active: activeSection==='plans'}" @click="activeSection='plans'" :disabled="!current">Plans</button>
                <button :class="{active: activeSection==='schedule'}" @click="activeSection='schedule'" :disabled="!current">Schedule</button>
            </div>
            <div class="toolbar-secondary">
                <input v-model="search" placeholder="Search trainees..." style="min-width:200px" />
                <button class="btn" @click="signOut">Sign out</button>
            </div>
        </div>

        <div class="card section-panel" :class="{active: activeSection==='exercises'}">
            <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">Exercises <span class="pill">{{ exerciseOptions.length }} total</span></h2>
            <div class="row">
                <div class="col">
                    <form @submit.prevent="addExerciseDefinition" style="display:flex;flex-direction:column;gap:8px">
                        <label class="small" style="display:flex;flex-direction:column;gap:4px">
                            Name
                            <input v-model="newExerciseName" placeholder="e.g. Push-ups" required />
                        </label>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button class="btn small" type="submit" :disabled="savingExercise">Add exercise</button>
                            <button class="small" type="button" @click="resetExerciseForm" :disabled="savingExercise">Reset</button>
                        </div>
                        <div v-if="savingExercise" class="muted small">Saving exercise…</div>
                    </form>
                </div>
                <div class="col">
                    <h3 style="margin-top:0">Available exercises</h3>
                    <div v-if="exerciseOptions.length===0" class="muted small">No exercises loaded yet.</div>
                    <div v-else class="exercise-list scroll-area">
                        <div v-for="ex in exerciseOptions" :key="ex.id" class="exercise-item small">
                            <div class="exercise-head">
                                <input v-model="exerciseEdits[ex.id].name" placeholder="Exercise name" />
                                <span class="pill">#{{ ex.id.slice(0,4) }}</span>
                            </div>
                            <div class="exercise-actions">
                                <button class="btn small" @click="updateExercise(ex)" :disabled="savingExercise">Save</button>
                                <button class="small" type="button" @click="resetExerciseEdit(ex)" :disabled="savingExercise">Reset</button>
                                <button class="small" type="button" @click="deleteExercise(ex)" :disabled="savingExercise" style="color:#fca5a5;border-color:#3b0f10;background:#1a0b0c">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row section-panel" :class="{active: activeSection==='trainees'}">
            <div class="col">
                <div class="card">
                    <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">Trainees <span class="pill">{{ filteredUsers.length }} shown</span></h2>
                    <div class="list scroll-area">
                        <div v-for="u in filteredUsers" :key="u.id" class="card" style="padding:12px">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                                <div>
                                    <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                    <div class="muted small mono">{{ u.id }}</div>
                                </div>
                                <span class="badge">trainee</span>
                            </div>
                            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                                <button class="btn" @click="selectUser(u); activeSection='schedule'">Open schedule</button>
                                <button class="btn" @click="loadDays(u); activeSection='schedule'">Load days</button>
                                <button class="btn" @click="loadPlans(u); activeSection='plans'">Load plans</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row section-panel" :class="{active: activeSection==='plans'}">
            <div class="col" v-if="!current">
                <div class="card">
                    <h2>Workout plans</h2>
                    <p class="muted">Select a trainee from the Trainees tab to manage their plans.</p>
                </div>
            </div>

            <div class="col" v-else>
                <div class="card">
                    <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">Add workout plan <span class="pill">{{ current.displayName || shortId(current.id) }}</span></h2>
                    <form @submit.prevent="addPlan" style="display:flex;flex-direction:column;gap:8px">
                        <label class="small stack">
                            Name
                            <input v-model="newPlanName" placeholder="e.g. Summer Strength" required />
                        </label>
                        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
                            <label class="small stack">
                                Status
                                <select v-model="newPlanStatus">
                                    <option v-for="status in planStatuses" :key="status" :value="status">{{ status }}</option>
                                </select>
                            </label>
                            <label class="small stack">
                                Starts at
                                <input type="date" v-model="newPlanStartsAt" />
                            </label>
                            <label class="small stack">
                                Ends at
                                <input type="date" v-model="newPlanEndsAt" />
                            </label>
                        </div>
                        <label class="small stack">
                            Notes
                            <textarea v-model="newPlanNotes" placeholder="Optional notes for the trainee"></textarea>
                        </label>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button class="btn small" type="submit" :disabled="savingPlan">Save plan</button>
                            <button class="small" type="button" @click="resetPlanForm" :disabled="savingPlan">Reset</button>
                        </div>
                        <div v-if="savingPlan" class="muted small">Saving plan…</div>
                    </form>
                </div>

                <div class="card">
                    <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">Plans <span class="pill">{{ plans.length }} total</span></h2>
                    <div v-if="plans.length===0" class="muted small">No plans for this trainee yet.</div>
                    <div v-else class="list scroll-area">
                        <div v-for="plan in plans" :key="plan.id" class="card stack small">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
                                <div class="stack">
                                    <strong>{{ planEdits[plan.id]?.name || plan.name }}</strong>
                                    <span class="muted mono small">#{{ shortId(plan.id) }}</span>
                                </div>
                                <div class="inline-actions">
                                    <button class="btn small" @click="savePlan(plan)" :disabled="savingPlan">Save</button>
                                    <button class="small" type="button" @click="resetPlanEdit(plan)" :disabled="savingPlan">Reset</button>
                                    <button class="small" type="button" @click="deletePlan(plan)" :disabled="savingPlan" style="color:#fca5a5;border-color:#3b0f10;background:#1a0b0c">Delete</button>
                                </div>
                            </div>
                            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px">
                                <label class="small stack">
                                    Name
                                    <input v-model="planEdits[plan.id].name" />
                                </label>
                                <label class="small stack">
                                    Status
                                    <select v-model="planEdits[plan.id].status">
                                        <option v-for="status in planStatuses" :key="status" :value="status">{{ status }}</option>
                                    </select>
                                </label>
                                <label class="small stack">
                                    Starts at
                                    <input type="date" v-model="planEdits[plan.id].starts_at" />
                                </label>
                                <label class="small stack">
                                    Ends at
                                    <input type="date" v-model="planEdits[plan.id].ends_at" />
                                </label>
                            </div>
                            <label class="small stack">
                                Notes
                                <textarea v-model="planEdits[plan.id].notes" placeholder="Optional notes"></textarea>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row section-panel" :class="{active: activeSection==='schedule'}">
            <div class="col" v-if="!current">
                <div class="card">
                    <h2>Schedule</h2>
                    <p class="muted">Pick a trainee from the Trainees tab to manage their schedule.</p>
                </div>
            </div>

            <div class="col" v-if="current">
                <div class="card">
                    <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">Schedule • {{ current.displayName || shortId(current.id) }} <span class="pill">{{ days.length }} days</span></h2>
                    <div class="grid">
                        <div class="card">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                                <h3 style="margin:0">Add Day</h3>
                                <span class="pill">Next: week {{ nextWeek }}</span>
                            </div>
                            <form @submit.prevent="addDay" style="display:flex;flex-direction:column;gap:8px;margin-top:6px">
                                <label class="small" style="display:flex;flex-direction:column;gap:4px">
                                    Week
                                    <input type="number" min="1" v-model.number="newDayWeek" required>
                                </label>
                                <label class="small" style="display:flex;flex-direction:column;gap:4px">
                                    Day code (e.g. MON)
                                    <input v-model="newDayCode" placeholder="MON" required>
                                </label>
                                <label class="small" style="display:flex;flex-direction:column;gap:4px">
                                    Title
                                    <input v-model="newDayTitle" placeholder="Workout title">
                                </label>
                                <label class="small" style="display:flex;flex-direction:column;gap:4px">
                                    Notes
                                    <textarea v-model="newDayNotes" placeholder="Optional notes"></textarea>
                                </label>
                                <div style="display:flex;gap:8px;flex-wrap:wrap">
                                    <button class="btn small" type="submit" :disabled="addingDay">Save day</button>
                                    <button class="small" type="button" @click="resetDayForm" :disabled="addingDay">Reset</button>
                                </div>
                                <div v-if="addingDay" class="muted small">Saving day…</div>
                            </form>
                        </div>

                        <div class="card">
                            <h3 style="margin-top:0">Days & Exercises</h3>
                            <div v-if="days.length===0">No days yet.</div>
                            <div v-else class="day-list scroll-area">
                                <div v-for="d in days" :key="d.id" class="day-card">
                                    <div class="day-header">
                                        <div class="stack">
                                            <div class="meta">
                                                <strong>Week {{ d.week }}</strong>
                                                <span class="tag accent">{{ d.day_code?.toUpperCase() }}</span>
                                                <span class="tag">{{ (d.day_exercises||[]).length }} exercises</span>
                                            </div>
                                            <div class="muted">{{ d.title || 'Untitled' }}</div>
                                        </div>
                                        <div class="inline-actions">
                                            <button class="small" type="button" @click="toggleDay(d)">{{ isDayOpen(d) ? 'Collapse' : 'Expand' }}</button>
                                            <button class="btn small" @click="saveDay(d)">Save</button>
                                            <button class="small" type="button" @click="resetDayEdit(d)">Reset</button>
                                            <button class="small" type="button" @click="deleteDay(d)" style="color:#fca5a5;border-color:#3b0f10;background:#1a0b0c">Delete</button>
                                        </div>
                                    </div>

                                    <div class="day-body" v-show="isDayOpen(d)">
                                        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px">
                                            <label class="small stack">
                                                Week
                                                <input type="number" min="1" v-model.number="dayEdits[d.id].week" />
                                            </label>
                                            <label class="small stack">
                                                Day code
                                                <input v-model="dayEdits[d.id].day_code" />
                                            </label>
                                            <label class="small stack">
                                                Title
                                                <input v-model="dayEdits[d.id].title" />
                                            </label>
                                        </div>
                                        <label class="small stack">
                                            Notes
                                            <textarea v-model="dayEdits[d.id].notes" placeholder="Optional notes"></textarea>
                                        </label>

                                        <div v-if="(d.day_exercises||[]).length" class="list">
                                            <div v-for="ex in d.day_exercises" :key="ex.id" class="card small stack">
                                                <div style="display:flex;justify-content:space-between;align-items:center;gap:6px;flex-wrap:wrap">
                                                    <strong>{{ ex.exercises?.name || 'Exercise' }}</strong>
                                                    <div style="display:flex;gap:6px;flex-wrap:wrap">
                                                        <button class="btn small" @click="saveDayExercise(ex)">Save</button>
                                                        <button class="small" type="button" @click="resetDayExerciseEdit(ex)">Reset</button>
                                                        <button class="small" type="button" @click="deleteDayExercise(ex)" style="color:#fca5a5;border-color:#3b0f10;background:#1a0b0c">Delete</button>
                                                    </div>
                                                </div>
                                                <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px">
                                                    <label class="small stack">
                                                        Position
                                                        <input type="number" min="1" v-model.number="dayExerciseEdits[ex.id].position" />
                                                    </label>
                                                    <label class="small stack">
                                                        Notes
                                                        <textarea v-model="dayExerciseEdits[ex.id].notes" placeholder="Optional notes"></textarea>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card small" style="margin-top:8px">
                                            <h4 style="margin:0 0 6px">Add exercise</h4>
                                            <div style="display:flex;flex-direction:column;gap:6px">
                                                <label class="small stack">
                                                    Search & select
                                                    <input v-model="exerciseSelection[d.id].query" @input="matchExercise(d)" placeholder="Type to filter exercises" :list="'dl-'+d.id">
                                                </label>
                                                <datalist :id="'dl-'+d.id">
                                                    <option v-for="opt in filteredExerciseOptions(d)" :key="opt.id" :value="opt.name"></option>
                                                </datalist>
                                                <div class="suggestions">
                                                    <span class="chip" v-for="opt in filteredExerciseOptions(d).slice(0,5)" :key="opt.id" @click="pickExercise(d, opt)">{{ opt.name }}</span>
                                                </div>
                                                <textarea v-model="exerciseSelection[d.id].notes" placeholder="Notes (optional)"></textarea>
                                                <button class="btn small" @click="addExerciseToDay(d)" :disabled="addingExercise">Add</button>
                                                <div class="muted small" v-if="!exerciseSelection[d.id].exercise_id">Start typing to auto-complete and click a suggestion.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vue 3 & Supabase JS v2 (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/vue@3.4.38/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
    // Fallback loader if CDNs are blocked
    (function(){
      function add(src){ var s=document.createElement('script'); s.src=src; s.crossOrigin='anonymous'; document.head.appendChild(s); }
      // Vue fallback
      window.addEventListener('error', function(){}, true);
      setTimeout(function(){
        if(!window.Vue){
          add('https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.38/vue.global.prod.min.js');
        }
        if(!window.supabase || !window.supabase.createClient){
          add('https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.45.4/supabase.min.js');
        }
      }, 300);
    })();
</script>
<!-- ESM fallback: import supabase-js as a module and expose a global factory -->
<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    window.SUPABASE_CREATE_CLIENT = createClient;
</script>
<script>
    (() => {
      const { createApp, ref, computed, onMounted } = Vue;

      // === Configure your Supabase project ===
      const SUPABASE_URL = 'https://jrqjysycoqhlnyufhliy.supabase.co';
      const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpycWp5c3ljb3FobG55dWZobGl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0MzM0NTIsImV4cCI6MjA2ODAwOTQ1Mn0.3BVA-Ar9YtLGGO12Gt6NQkMl2cn18E_b48PGtlFxxCw';
      const g = window;
      const createClient = (g.supabase && g.supabase.createClient) || (g.Supabase && g.Supabase.createClient) || g.SUPABASE_CREATE_CLIENT;
      if (!createClient) {
        console.error('Supabase JS failed to load from all CDNs (jsDelivr/ESM).');
        alert('Supabase library failed to load. Check your network or replace with local copies.');
        return; // stop bootstrapping
      }
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

      createApp({
        setup(){
          const session = ref(null);
          const user = ref(null);
          const email = ref('');
          const password = ref('');
          const search = ref('');
          const activeSection = ref('exercises');

          const users = ref([]);
          const current = ref(null);
          const days = ref([]);
          const plans = ref([]);
          const exerciseOptions = ref([]);
          const exerciseSelection = ref({});
          const exerciseEdits = ref({});
          const dayEdits = ref({});
          const dayExerciseEdits = ref({});
          const planEdits = ref({});
          const expandedDays = ref({});
          const addingDay = ref(false);
          const addingExercise = ref(false);
          const savingExercise = ref(false);
          const savingPlan = ref(false);
          const newDayWeek = ref(1);
          const newDayCode = ref('MON');
          const newDayTitle = ref('');
          const newDayNotes = ref('');
          const newExerciseName = ref('');
          const planStatuses = ['active','upcoming','draft','archived'];
          const newPlanName = ref('');
          const newPlanStatus = ref(planStatuses[0]);
          const newPlanStartsAt = ref('');
          const newPlanEndsAt = ref('');
          const newPlanNotes = ref('');

          const nextWeek = computed(() => {
            if(!days.value.length) return 1;
            const weeks = days.value.map(d => Number(d.week||0));
            return Math.max(...weeks) + 1;
          });

          const filteredUsers = computed(() => {
            const q = search.value.trim().toLowerCase();
            if(!q) return users.value;
            return users.value.filter(u =>
              (u.displayName || '').toLowerCase().includes(q) ||
              (u.id || '').toLowerCase().includes(q)
            );
          });

          const shortId = (id) => id ? id.toString().slice(0,8)+'…' : '';

          function resetDayForm(){
            newDayWeek.value = 1;
            newDayCode.value = 'MON';
            newDayTitle.value = '';
            newDayNotes.value = '';
          }

          function resetExerciseForm(){
            newExerciseName.value = '';
          }

          function resetExerciseEdit(ex){ setExerciseEdit(ex); }

          function resetDayEdit(day){ setDayEdit(day); }

          function resetDayExerciseEdit(ex){ setDayExerciseEdit(ex); }

          function resetPlanForm(){
            newPlanName.value = '';
            newPlanStatus.value = planStatuses[0];
            newPlanStartsAt.value = '';
            newPlanEndsAt.value = '';
            newPlanNotes.value = '';
          }

          function normalizeDateInput(value){
            if(!value) return '';
            if(typeof value === 'string'){
              return value.split('T')[0];
            }
            try {
              return new Date(value).toISOString().slice(0,10);
            } catch(_e){
              return '';
            }
          }

          function setPlanEdit(plan){
            if(!plan?.id) return;
            planEdits.value = {
              ...planEdits.value,
              [plan.id]: {
                name: plan.name || '',
                status: plan.status || planStatuses[0],
                starts_at: normalizeDateInput(plan.starts_at),
                ends_at: normalizeDateInput(plan.ends_at),
                notes: plan.notes || ''
              }
            };
          }

          function resetPlanEdit(plan){ setPlanEdit(plan); }

          function ensureSelection(dayId){
            if(!exerciseSelection.value[dayId]){
              exerciseSelection.value = { ...exerciseSelection.value, [dayId]: { exercise_id: '', notes: '', query: '' } };
              return;
            }
            if(exerciseSelection.value[dayId] && typeof exerciseSelection.value[dayId].query !== 'string'){
              exerciseSelection.value = { ...exerciseSelection.value, [dayId]: { ...exerciseSelection.value[dayId], query: '' } };
            }
          }

          function setDayExpansion(dayId, open=true){
            expandedDays.value = { ...expandedDays.value, [dayId]: open };
          }

          function isDayOpen(day){
            return !!expandedDays.value[day.id];
          }

          function toggleDay(day){
            setDayExpansion(day.id, !isDayOpen(day));
          }

          function filteredExerciseOptions(day){
            const q = (exerciseSelection.value[day.id]?.query || '').toLowerCase();
            if(!q) return exerciseOptions.value || [];
            return (exerciseOptions.value||[]).filter(opt => opt.name.toLowerCase().includes(q));
          }

          function pickExercise(day, opt){
            ensureSelection(day.id);
            exerciseSelection.value = { ...exerciseSelection.value, [day.id]: { ...exerciseSelection.value[day.id], exercise_id: opt.id, query: opt.name } };
          }

          function matchExercise(day){
            ensureSelection(day.id);
            const query = (exerciseSelection.value[day.id].query || '').toLowerCase();
            const match = (exerciseOptions.value||[]).find(opt => opt.name.toLowerCase() === query);
            exerciseSelection.value = { ...exerciseSelection.value, [day.id]: { ...exerciseSelection.value[day.id], exercise_id: match?.id || '' } };
          }

          function setExerciseEdit(exercise){
            if(!exercise?.id) return;
            exerciseEdits.value = {
              ...exerciseEdits.value,
              [exercise.id]: { name: exercise.name || '' }
            };
          }

          function setDayEdit(day){
            if(!day?.id) return;
            dayEdits.value = {
              ...dayEdits.value,
              [day.id]: {
                week: day.week ?? 1,
                day_code: day.day_code || '',
                title: day.title || '',
                notes: day.notes || ''
              }
            };
          }

          function setDayExerciseEdit(exercise){
            if(!exercise?.id) return;
            dayExerciseEdits.value = {
              ...dayExerciseEdits.value,
              [exercise.id]: {
                position: exercise.position ?? 1,
                notes: exercise.notes || ''
              }
            };
          }

          async function emailPasswordSignIn(){
            const { data, error } = await supabase.auth.signInWithPassword({ email: email.value, password: password.value });
            if(error){ alert(error.message); return; }
            session.value = data.session; user.value = data.user;
            await bootstrap();
          }
          async function signOut(){ await supabase.auth.signOut(); location.reload(); }

          async function bootstrap(){
            await loadUsers();
            await loadExercises();
            if(users.value.length){
              selectUser(users.value[0]);
              await loadPlans(users.value[0]);
              await loadDays(users.value[0]);
            }
          }

          async function loadUsers(){
            const { data: traineeRows, error } = await supabase
              .from('trainees')
              .select('id, name')
              .order('name', { ascending: true });
            if(error){ console.error(error); alert('Failed to load trainees: '+error.message); return; }

            users.value = (traineeRows||[]).map(row => ({
              ...row,
              displayName: row.name || shortId(row.id),
            }));
          }

          function selectUser(u){
            current.value = u;
            days.value = [];
            plans.value = [];
            planEdits.value = {};
            expandedDays.value = {};
          }

          async function loadExercises(){
            const { data, error } = await supabase
              .from('exercises')
              .select('id, name')
              .order('name', { ascending: true });
            if(error){ console.error(error); alert('Failed to load exercises: '+error.message); return; }
            exerciseOptions.value = data || [];
            (exerciseOptions.value||[]).forEach(setExerciseEdit);
          }

          async function loadPlans(u=current.value){
            if(!u) return;
            const { data, error } = await supabase
              .from('workout_plans')
              .select('id, name, status, starts_at, ends_at, notes, trainee_id, created_at')
              .eq('trainee_id', u.id)
              .order('starts_at', { ascending:false, nullsLast:false })
              .order('created_at', { ascending:false });
            if(error){ console.error(error); alert('Failed to load plans: '+error.message); return; }
            plans.value = data || [];
            planEdits.value = {};
            (plans.value||[]).forEach(setPlanEdit);
          }

          async function addExerciseDefinition(){
            const name = newExerciseName.value.trim();
            if(!name){ alert('Exercise name is required.'); return; }
            savingExercise.value = true;
            try {
              const { error } = await supabase
                .from('exercises')
                .insert({ name });
              if(error){ throw new Error('Create exercise failed: '+error.message); }
              resetExerciseForm();
              await loadExercises();
            } catch(err){
              console.error(err);
              alert(err.message || 'Failed to create exercise.');
            } finally {
              savingExercise.value = false;
            }
          }

          async function updateExercise(ex){
            if(!ex?.id) return;
            const name = (exerciseEdits.value[ex.id]?.name || '').trim();
            if(!name){ alert('Exercise name cannot be empty.'); return; }
            savingExercise.value = true;
            try {
              const { error } = await supabase
                .from('exercises')
                .update({ name })
                .eq('id', ex.id);
              if(error){ throw new Error('Update exercise failed: '+error.message); }
              await loadExercises();
              await loadDays();
            } catch(err){
              console.error(err);
              alert(err.message || 'Failed to update exercise.');
            } finally {
              savingExercise.value = false;
            }
          }

          async function deleteExercise(ex){
            if(!ex?.id) return;
            const confirmed = confirm('Delete exercise "'+(ex.name||ex.id)+'"?');
            if(!confirmed) return;
            savingExercise.value = true;
            try {
              const { error } = await supabase
                .from('exercises')
                .delete()
                .eq('id', ex.id);
              if(error){ throw new Error('Delete exercise failed: '+error.message); }
              await loadExercises();
              await loadDays();
            } catch(err){
              console.error(err);
              alert(err.message || 'Failed to delete exercise.');
            } finally {
              savingExercise.value = false;
            }
          }

          async function loadDays(u=current.value){
            if(!u) return;
            const { data, error } = await supabase
              .from('days')
              .select(`
                id, week, day_code, title, notes,
                day_exercises (
                  id, position, notes,
                  exercises ( id, name )
                )
              `)
              .eq('trainee_id', u.id)
              .order('week', { ascending:true })
              .order('day_code', { ascending:true })
              .order('position', { ascending:true, referencedTable:'day_exercises' });
            if(error){ alert('Failed to load days: '+error.message); return; }
            days.value = data || [];
            (days.value||[]).forEach(d => ensureSelection(d.id));
            (days.value||[]).forEach(setDayEdit);
            (days.value||[]).forEach(d => (d.day_exercises||[]).forEach(setDayExerciseEdit));
            (days.value||[]).forEach((d, idx) => {
              if(expandedDays.value[d.id] === undefined){
                setDayExpansion(d.id, idx === 0);
              }
            });
          }

          async function addPlan(){
            if(!current.value){ alert('Select a trainee first.'); return; }
            const name = (newPlanName.value || '').trim();
            if(!name){ alert('Plan name is required.'); return; }
            savingPlan.value = true;
            try {
              const payload = {
                trainee_id: current.value.id,
                name,
                status: (newPlanStatus.value || '').trim() || null,
                starts_at: newPlanStartsAt.value || null,
                ends_at: newPlanEndsAt.value || null,
                notes: (newPlanNotes.value || '').trim() || null,
              };
              const { error } = await supabase
                .from('workout_plans')
                .insert(payload);
              if(error){ throw new Error('Create plan failed: '+error.message); }
              resetPlanForm();
              await loadPlans();
            } catch(err){
              console.error(err);
              alert(err.message || 'Failed to create plan.');
            } finally {
              savingPlan.value = false;
            }
          }

          async function addDay(){
            if(!current.value){ alert('Select a trainee first.'); return; }
            const week = Number(newDayWeek.value || 1);
            const dayCode = (newDayCode.value || '').trim();
            if(!dayCode){ alert('Day code is required.'); return; }
            addingDay.value = true;
            try {
              const { error } = await supabase
                .from('days')
                .insert({
                  trainee_id: current.value.id,
                  week: week,
                  day_code: dayCode,
                  title: newDayTitle.value.trim() || null,
                  notes: newDayNotes.value.trim() || null,
                });
              if(error){ throw new Error('Create day failed: '+error.message); }
              resetDayForm();
              await loadDays();
            } catch(err){
              console.error(err);
              alert(err.message || 'Failed to create day.');
            } finally {
              addingDay.value = false;
            }
          }

          async function savePlan(plan){
            if(!plan?.id){ alert('Missing plan.'); return; }
            const form = planEdits.value[plan.id] || {};
            const name = (form.name || '').trim();
            if(!name){ alert('Plan name is required.'); return; }
            savingPlan.value = true;
            try {
              const payload = {
                name,
                status: (form.status || '').trim() || null,
                starts_at: form.starts_at || null,
                ends_at: form.ends_at || null,
                notes: (form.notes || '').trim() || null,
              };
              const { error } = await supabase
                .from('workout_plans')
                .update(payload)
                .eq('id', plan.id);
              if(error){ throw new Error('Update plan failed: '+error.message); }
              await loadPlans();
            } catch(err){
              console.error(err);
              alert(err.message || 'Failed to update plan.');
            } finally {
              savingPlan.value = false;
            }
          }

          async function deletePlan(plan){
            if(!plan?.id) return;
            const confirmed = confirm('Delete this plan?');
            if(!confirmed) return;
            savingPlan.value = true;
            try {
              const { error } = await supabase
                .from('workout_plans')
                .delete()
                .eq('id', plan.id);
              if(error){ throw new Error('Delete plan failed: '+error.message); }
              await loadPlans();
            } catch(err){
              console.error(err);
              alert(err.message || 'Failed to delete plan.');
            } finally {
              savingPlan.value = false;
            }
          }

          async function addExerciseToDay(day){
            if(!day?.id){ alert('Missing day.'); return; }
            ensureSelection(day.id);
            const selection = exerciseSelection.value[day.id];
            const exerciseId = selection?.exercise_id;
            if(!exerciseId){ alert('Choose an exercise first.'); return; }
            addingExercise.value = true;
            try {
              const positions = (day.day_exercises||[])
                .map(ex => typeof ex.position === 'number' ? ex.position : Number(ex.position) || 0);
              const nextPosition = (positions.length ? Math.max(...positions) : 0) + 1;
              const { error } = await supabase
                .from('day_exercises')
                .insert({
                  day_id: day.id,
                  exercise_id: exerciseId,
                  notes: (selection.notes||'').trim() || null,
                  position: nextPosition,
                });
              if(error){ throw new Error('Add exercise failed: '+error.message); }
              exerciseSelection.value = { ...exerciseSelection.value, [day.id]: { exercise_id: '', notes: '' } };
              await loadDays();
            } catch(err){
              console.error(err);
              alert(err.message || 'Failed to add exercise.');
            } finally {
              addingExercise.value = false;
            }
          }

          async function saveDay(day){
            if(!day?.id){ alert('Missing day.'); return; }
            const form = dayEdits.value[day.id] || {};
            const week = Number(form.week || 1);
            const dayCode = (form.day_code || '').trim();
            if(!dayCode){ alert('Day code is required.'); return; }
            const payload = {
              week,
              day_code: dayCode,
              title: (form.title||'').trim() || null,
              notes: (form.notes||'').trim() || null,
            };
            const { error } = await supabase
              .from('days')
              .update(payload)
              .eq('id', day.id);
            if(error){ alert('Failed to update day: '+error.message); return; }
            await loadDays();
          }

          async function deleteDay(day){
            if(!day?.id) return;
            const confirmed = confirm('Delete this day and its exercises?');
            if(!confirmed) return;
            const { error } = await supabase
              .from('days')
              .delete()
              .eq('id', day.id);
            if(error){ alert('Failed to delete day: '+error.message); return; }
            await loadDays();
          }

          async function saveDayExercise(ex){
            if(!ex?.id){ alert('Missing day exercise.'); return; }
            const form = dayExerciseEdits.value[ex.id] || {};
            const payload = {
              position: Number(form.position || 1),
              notes: (form.notes||'').trim() || null,
            };
            const { error } = await supabase
              .from('day_exercises')
              .update(payload)
              .eq('id', ex.id);
            if(error){ alert('Failed to update exercise: '+error.message); return; }
            await loadDays();
          }

          async function deleteDayExercise(ex){
            if(!ex?.id) return;
            const confirmed = confirm('Remove exercise from day?');
            if(!confirmed) return;
            const { error } = await supabase
              .from('day_exercises')
              .delete()
              .eq('id', ex.id);
            if(error){ alert('Failed to delete exercise: '+error.message); return; }
            await loadDays();
          }

          onMounted(async () => {
            const { data: { session: sess } } = await supabase.auth.getSession();
            session.value = sess; user.value = sess?.user || null;
            if(session.value) await bootstrap();

            supabase.auth.onAuthStateChange((_e, s) => { session.value = s; user.value = s?.user || null; if(s) bootstrap(); });
          });

          return { session, user, email, password, search, activeSection, users, filteredUsers, current, days, exerciseOptions, exerciseSelection,
                   exerciseEdits, dayEdits, dayExerciseEdits, expandedDays, nextWeek, plans, planEdits, planStatuses,
                   newDayWeek, newDayCode, newDayTitle, newDayNotes, addingDay, addingExercise, savingExercise, savingPlan,
                   newExerciseName, newPlanName, newPlanStatus, newPlanStartsAt, newPlanEndsAt, newPlanNotes,
                   emailPasswordSignIn, signOut, selectUser, loadDays, loadPlans, addPlan, addDay, resetDayForm, resetExerciseForm, resetPlanForm, addExerciseDefinition, addExerciseToDay,
                   updateExercise, deleteExercise, resetExerciseEdit, filteredExerciseOptions, pickExercise, matchExercise, toggleDay, isDayOpen,
                   saveDay, resetDayEdit, deleteDay, resetPlanEdit, savePlan, deletePlan,
                   saveDayExercise, resetDayExerciseEdit, deleteDayExercise,
                   shortId };
        }
      }).mount('#app');
    })();
</script>
</body>
</html>
