<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calisync Admin Portal</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
<div id="app" class="wrap">
    <div v-if="!session" class="card" style="max-width:460px;margin:60px auto;">
        <h1>{{ t('app.title') }}</h1>
        <p class="muted">{{ t('auth.subtitle') }}</p>
        <form @submit.prevent="emailPasswordSignIn" style="display:flex;flex-direction:column;gap:10px;margin-top:12px">
            <input v-model="email" type="email" :placeholder="t('placeholders.email')" required>
            <input v-model="password" type="password" :placeholder="t('placeholders.password')" required>
            <button class="btn">{{ t('actions.signIn') }}</button>
        </form>
    </div>

    <div v-else>
        <div class="toolbar">
            <div style="display:flex;align-items:center;gap:10px">
                <div class="pill">{{ user?.email }}</div>
                <span class="pill">{{ roleLabel }}</span>
            </div>
            <div class="pill-menu">
                <button :class="{active: activeSection==='dashboard'}" @click="activeSection='dashboard'">{{ t('sections.dashboard') }}</button>
                <button :class="{active: activeSection==='trainees'}" @click="activeSection='trainees'">{{ t('sections.trainees') }}</button>
                <button :class="{active: activeSection==='program'}" @click="activeSection='program'">{{ t('sections.program') }}</button>
            </div>
            <div class="toolbar-secondary">
                <select v-model="locale" class="pill" :aria-label="t('toolbar.language')">
                    <option v-for="option in languageOptions" :key="option.value" :value="option.value">{{ option.label }}</option>
                </select>
                <input v-model="search" :placeholder="t('toolbar.searchPlaceholder')" style="min-width:200px" />
                <button class="btn" @click="signOut">{{ t('actions.signOut') }}</button>
            </div>
        </div>

        <div class="section-panel dashboard-panel" :class="{active: activeSection==='dashboard'}">
            <div class="dashboard-grid">
                <div class="card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('dashboard.feedbackTitle') }}</h2>
                            <span class="muted small">{{ t('dashboard.feedbackSubtitle') }}</span>
                        </div>
                        <button class="small" type="button" @click="loadDashboardNotes" :disabled="dashboardNotesLoading">{{ t('actions.refresh') }}</button>
                    </div>
                    <div v-if="dashboardNotesLoading" class="muted small">{{ t('dashboard.loadingFeedback') }}</div>
                    <div v-else-if="dashboardNotesError" class="muted small">{{ dashboardNotesError }}</div>
                    <div v-else-if="dashboardNotes.length===0" class="muted small">{{ t('dashboard.noFeedback') }}</div>
                    <div v-else class="chat-list">
                        <div v-for="note in dashboardNotes" :key="note.id" class="chat-item">
                            <div class="chat-meta">
                                <strong>{{ note.traineeName }}</strong>
                                <span class="pill">{{ note.dayLabel }}</span>
                            </div>
                            <div class="muted small" v-if="note.dateLabel">{{ note.dateLabel }}</div>
                            <div class="chat-message">{{ note.notes }}</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('dashboard.noticesTitle') }}</h2>
                            <span class="muted small">{{ t('dashboard.noticesSubtitle') }}</span>
                        </div>
                    </div>
                    <form class="stack" @submit.prevent="addAnnouncement">
                        <textarea v-model="newAnnouncement" :placeholder="t('dashboard.noticePlaceholder')"></textarea>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button class="btn small" type="submit">{{ t('dashboard.addNotice') }}</button>
                        </div>
                    </form>
                    <div v-if="announcements.length===0" class="muted small" style="margin-top:10px">{{ t('dashboard.noNotices') }}</div>
                    <div v-else class="notice-list">
                        <div class="notice-item" v-for="notice in announcements" :key="notice.id">
                            <div class="stack">
                                <strong>{{ notice.text }}</strong>
                                <span class="muted small" v-if="notice.dateLabel">{{ notice.dateLabel }}</span>
                            </div>
                            <button class="small" type="button" @click="removeAnnouncement(notice)">{{ t('actions.delete') }}</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('dashboard.paymentsTitle') }}</h2>
                            <span class="muted small">{{ t('dashboard.paymentsSubtitle') }}</span>
                        </div>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span class="summary-label">{{ t('dashboard.paymentsTotal') }}</span>
                            <strong>{{ paymentSummary.total }}</strong>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">{{ t('dashboard.paymentsOnTime') }}</span>
                            <strong>{{ paymentSummary.paid }}</strong>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">{{ t('dashboard.paymentsOverdue') }}</span>
                            <strong>{{ paymentSummary.overdue }}</strong>
                        </div>
                    </div>
                    <div v-if="overdueUsers.length===0" class="muted small" style="margin-top:10px">{{ t('dashboard.noOverdue') }}</div>
                    <div v-else class="list" style="margin-top:10px">
                        <div v-for="u in overdueUsers" :key="u.id" class="payment-alert">
                            <div class="stack">
                                <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                <span class="muted small mono">{{ u.id }}</span>
                            </div>
                            <button class="small" type="button" @click="selectUser(u); activeSection='program'">{{ t('dashboard.openProgram') }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row section-panel" :class="{active: activeSection==='trainees'}">
            <div class="col">
                <div class="card">
                    <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                        {{ t('sections.trainees') }}
                        <span class="pill">{{ t('labels.shownCount', { count: filteredUsers.length }) }}</span>
                    </h2>
                    <div class="muted small" v-if="loadingProgress">{{ t('status.refreshingProgress') }}</div>
                    <div class="list scroll-area">
                        <div v-for="u in filteredUsers" :key="u.id" class="card" style="padding:12px">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                                <div>
                                    <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                    <div class="muted small mono">{{ u.id }}</div>
                                </div>
                                <span class="badge">{{ t('trainees.badge') }}</span>
                            </div>
                            <div class="progress-row" v-if="progressFor(u).total">
                                <div class="progress-bar">
                                    <span :style="{ width: progressFor(u).percent + '%' }"></span>
                                </div>
                                <div class="progress-meta small">
                                    <span>{{ progressFor(u).percent }}%</span>
                                    <span class="muted">{{ progressFor(u).completed }}/{{ progressFor(u).total }}</span>
                                </div>
                            </div>
                            <div class="muted small" v-else>{{ t('status.noProgress') }}</div>
                            <div class="trainer-row">
                                <span class="muted small">{{ t('trainers.assigned') }}</span>
                                <div class="trainer-tags">
                                    <span v-if="!u.trainers || u.trainers.length===0" class="muted small">
                                        {{ t('trainers.none') }}
                                    </span>
                                    <span v-else v-for="trainer in u.trainers" :key="trainer.id" class="pill trainer-pill">
                                        {{ trainer.name }}
                                        <button
                                            v-if="canAssignTrainers"
                                            class="icon-button"
                                            type="button"
                                            @click="removeTrainerAssignment(u, trainer)"
                                            :aria-label="t('actions.delete')"
                                        >
                                            √ó
                                        </button>
                                    </span>
                                </div>
                            </div>
                            <div v-if="canAssignTrainers" class="trainer-assign">
                                <select v-model="trainerSelections[u.id]">
                                    <option value="">{{ t('trainers.select') }}</option>
                                    <option
                                        v-for="trainer in trainers"
                                        :key="trainer.id"
                                        :value="trainer.id"
                                        :disabled="u.trainerIds && u.trainerIds.includes(trainer.id)"
                                    >
                                        {{ trainer.name }}
                                    </option>
                                </select>
                                <button
                                    class="small"
                                    type="button"
                                    :disabled="trainerAssignmentSaving[u.id] || !trainerSelections[u.id]"
                                    @click="assignTrainerToTrainee(u)"
                                >
                                    {{ t('actions.assignTrainer') }}
                                </button>
                            </div>
                            <div class="payment-row">
                                <span class="pill" :class="u.paid ? 'paid' : 'overdue'">
                                    {{ u.paid ? t('payment.onTime') : t('payment.overdue') }}
                                </span>
                                <label class="payment-toggle small">
                                    <input
                                        type="checkbox"
                                        :checked="u.paid"
                                        :disabled="paymentSaving[u.id]"
                                        @change="togglePayment(u, $event)"
                                    />
                                    <span>{{ t('payment.toggle') }}</span>
                                </label>
                            </div>
                            <div class="muted small" v-if="paymentSaving[u.id]">{{ t('status.updatingPayment') }}</div>
                            <div class="muted small" v-if="trainerAssignmentSaving[u.id]">{{ t('status.updatingTrainer') }}</div>
                            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                                <button class="btn" @click="selectUser(u); activeSection='program'">{{ t('actions.openSchedule') }}</button>
                                <button class="btn" @click="loadDays(u); activeSection='program'">{{ t('actions.loadDays') }}</button>
                                <button class="btn" @click="loadPlans(u); activeSection='program'">{{ t('actions.loadPlans') }}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row section-panel program-panel" :class="{active: activeSection==='program'}">
            <div class="col program-main">
                <div class="card" v-if="!current">
                    <h2>{{ t('program.title') }}</h2>
                    <p class="muted">{{ t('program.empty') }}</p>
                </div>

                <template v-else>
                    <div class="card">
                        <h2 style="margin:0">{{ t('program.titleWithName', { name: current.displayName || shortId(current.id) }) }}</h2>
                        <p class="muted">{{ t('program.subtitle') }}</p>
                    </div>

                    <div class="card program-template">
                        <div class="program-template-header">
                            <div class="stack">
                                <h2 style="margin:0">{{ t('program.templateTitle') }}</h2>
                                <span class="muted small">{{ t('program.templateSubtitle') }}</span>
                            </div>
                            <label class="small stack">
                                {{ t('program.dayCountLabel') }}
                                <select v-model.number="templateDayCount">
                                    <option v-for="count in templateDayOptions" :key="count" :value="count">{{ count }}</option>
                                </select>
                            </label>
                        </div>
                        <div class="template-grid">
                            <div v-for="day in programTemplateDays" :key="day.id" class="template-day">
                                <h3 style="margin-top:0">{{ t('program.templateDay', { day: day.index }) }}</h3>
                                <div class="template-slots">
                                    <div v-for="(slot, idx) in day.slots" :key="idx" class="template-slot">
                                        <input v-model="slot.exercise" :placeholder="t('program.templateExercisePlaceholder')" />
                                        <input v-model="slot.sets" :placeholder="t('program.templateSetsPlaceholder')" />
                                        <input v-model="slot.notes" :placeholder="t('program.templateNotesPlaceholder')" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">{{ t('plans.addTitle') }} <span class="pill">{{ current.displayName || shortId(current.id) }}</span></h2>
                        <form @submit.prevent="addPlan" style="display:flex;flex-direction:column;gap:8px">
                            <label class="small stack">
                                {{ t('labels.name') }}
                                <input v-model="newPlanName" :placeholder="t('placeholders.planExample')" required />
                            </label>
                            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
                                <label class="small stack">
                                    {{ t('labels.status') }}
                                    <select v-model="newPlanStatus">
                                        <option v-for="status in planStatuses" :key="status" :value="status">{{ planStatusLabel(status) }}</option>
                                    </select>
                                </label>
                                <label class="small stack">
                                    {{ t('labels.startsAt') }}
                                    <input type="date" v-model="newPlanStartsAt" />
                                </label>
                                <label class="small stack">
                                    {{ t('labels.endsAt') }}
                                    <input type="date" v-model="newPlanEndsAt" />
                                </label>
                            </div>
                            <label class="small stack">
                                {{ t('labels.notes') }}
                                <textarea v-model="newPlanNotes" :placeholder="t('placeholders.planNotes')"></textarea>
                            </label>
                            <div style="display:flex;gap:8px;flex-wrap:wrap">
                                <button class="btn small" type="submit" :disabled="savingPlan">{{ t('actions.savePlan') }}</button>
                                <button class="small" type="button" @click="resetPlanForm" :disabled="savingPlan">{{ t('actions.reset') }}</button>
                            </div>
                            <div v-if="savingPlan" class="muted small">{{ t('status.savingPlan') }}</div>
                        </form>
                    </div>

                    <div class="card">
                        <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">{{ t('plans.listTitle') }} <span class="pill">{{ t('labels.totalCount', { count: plans.length }) }}</span></h2>
                        <div v-if="plans.length===0" class="muted small">{{ t('plans.none') }}</div>
                        <div v-else class="list scroll-area">
                            <div v-for="plan in plans" :key="plan.id" class="card stack small">
                                <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
                                    <div class="stack">
                                        <strong>{{ planEdits[plan.id]?.title || plan.title }}</strong>
                                        <span class="muted mono small">#{{ shortId(plan.id) }}</span>
                                    </div>
                                    <div class="inline-actions">
                                        <button class="btn small" @click="savePlan(plan)" :disabled="savingPlan">{{ t('actions.save') }}</button>
                                        <button class="small" type="button" @click="resetPlanEdit(plan)" :disabled="savingPlan">{{ t('actions.reset') }}</button>
                                        <button class="small" type="button" @click="deletePlan(plan)" :disabled="savingPlan" style="color:#fca5a5;border-color:#3b0f10;background:#1a0b0c">{{ t('actions.delete') }}</button>
                                    </div>
                                </div>
                                <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px">
                                    <label class="small stack">
                                        {{ t('labels.name') }}
                                        <input v-model="planEdits[plan.id].title" />
                                    </label>
                                    <label class="small stack">
                                        {{ t('labels.status') }}
                                        <select v-model="planEdits[plan.id].status">
                                            <option v-for="status in planStatuses" :key="status" :value="status">{{ planStatusLabel(status) }}</option>
                                        </select>
                                    </label>
                                    <label class="small stack">
                                        {{ t('labels.startsAt') }}
                                        <input type="date" v-model="planEdits[plan.id].starts_on" />
                                    </label>
                                </div>
                                <label class="small stack">
                                    {{ t('labels.notes') }}
                                    <textarea v-model="planEdits[plan.id].notes" :placeholder="t('placeholders.notesOptional')"></textarea>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="card program-schedule">
                        <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">{{ t('sections.schedule') }} ‚Ä¢ {{ current.displayName || shortId(current.id) }} <span class="pill">{{ formatCount(days.length, 'labels.dayCount', 'labels.daysCount') }}</span></h2>
                        <div class="grid">
                            <div class="card day-form-card">
                                <div class="day-form-header">
                                    <h3 style="margin:0">{{ t('schedule.createDay') }}</h3>
                                    <span class="pill">{{ t('schedule.nextWeek', { week: nextWeek }) }}</span>
                                </div>
                                <div class="inline-actions">
                                    <button class="small" type="button" @click="applyNextWeek">{{ t('actions.useNextWeek') }}</button>
                                    <button class="small" type="button" @click="resetDayForm" :disabled="addingDay">{{ t('actions.clear') }}</button>
                                </div>
                                <form @submit.prevent="addDay" class="stack">
                                    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
                                        <label class="small stack">
                                            {{ t('labels.week') }}
                                            <input type="number" min="1" v-model.number="newDayWeek" required>
                                        </label>
                                        <label class="small stack">
                                            {{ t('labels.dayCode') }}
                                            <select v-model="newDayCode" required>
                                                <option v-for="code in dayCodeOptions" :key="code" :value="code">{{ dayCodeLabel(code) }}</option>
                                            </select>
                                        </label>
                                        <label class="small stack">
                                            {{ t('labels.title') }}
                                            <input v-model="newDayTitle" :placeholder="t('placeholders.workoutTitle')" list="day-title-options">
                                        </label>
                                    </div>
                                    <datalist id="day-title-options">
                                        <option v-for="title in dayTitleSuggestions" :key="title" :value="title"></option>
                                    </datalist>
                                    <datalist id="day-code-options">
                                        <option v-for="code in dayCodeOptions" :key="code" :value="code"></option>
                                    </datalist>
                                    <div class="stack">
                                        <span class="small">{{ t('schedule.quickDayPick') }}</span>
                                        <div class="day-code-picker">
                                            <button v-for="code in dayCodeOptions" :key="code" type="button" :class="{active: newDayCode === code}" @click="setDayCode(code)">{{ dayCodeLabel(code) }}</button>
                                        </div>
                                        <span class="helper-text">{{ t('schedule.quickDayHelp') }}</span>
                                    </div>
                                    <label class="small stack">
                                        {{ t('labels.notes') }}
                                        <textarea v-model="newDayNotes" :placeholder="t('placeholders.notesOptional')"></textarea>
                                    </label>
                                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                                        <button class="btn small" type="submit" :disabled="addingDay">{{ t('actions.saveDay') }}</button>
                                        <button class="small" type="button" @click="resetDayForm" :disabled="addingDay">{{ t('actions.reset') }}</button>
                                    </div>
                                    <div v-if="addingDay" class="muted small">{{ t('status.savingDay') }}</div>
                                </form>
                            </div>

                            <div class="card schedule-summary">
                                <div class="schedule-summary-header">
                                    <div class="stack">
                                        <h3 style="margin:0">{{ t('schedule.recap') }}</h3>
                                        <span class="muted small">{{ t('schedule.recapSubtitle') }}</span>
                                    </div>
                                    <button class="small" type="button" @click="loadDays" :disabled="addingDay || addingExercise">{{ t('actions.refresh') }}</button>
                                </div>
                                <div class="summary-grid">
                                    <div class="summary-item">
                                        <span class="summary-label">{{ t('labels.weeks') }}</span>
                                        <strong>{{ scheduleSummary.weeks }}</strong>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">{{ t('labels.days') }}</span>
                                        <strong>{{ scheduleSummary.days }}</strong>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">{{ t('labels.exercises') }}</span>
                                        <strong>{{ scheduleSummary.exercises }}</strong>
                                    </div>
                                    <div class="summary-item">
                                        <span class="summary-label">{{ t('labels.daysWithExercises') }}</span>
                                        <strong>{{ scheduleSummary.daysWithExercises }}</strong>
                                    </div>
                                </div>
                                <div v-if="scheduleSummary.highlights.length" class="summary-highlights">
                                    <span class="summary-label">{{ t('schedule.highlights') }}</span>
                                    <div class="summary-chips">
                                        <span class="chip" v-for="item in scheduleSummary.highlights" :key="item.id">
                                            {{ item.label }} ‚Ä¢ {{ item.exercises }} {{ t('labels.exerciseShort') }}
                                        </span>
                                    </div>
                                </div>
                                <div v-else class="muted small">{{ t('schedule.recapEmpty') }}</div>
                            </div>

                            <div class="card schedule-nav">
                                <h3 style="margin-top:0">{{ t('schedule.jumpToDay') }}</h3>
                                <div class="muted small">{{ t('schedule.jumpSubtitle') }}</div>
                                <div v-if="dayNavigation.length" class="jump-list">
                                    <button
                                        v-for="item in dayNavigation"
                                        :key="item.id"
                                        class="small jump-button"
                                        type="button"
                                        @click="jumpToDay(item)"
                                    >
                                        <span>{{ item.label }}</span>
                                        <span class="muted">{{ item.exercises }} {{ t('labels.exerciseShort') }}</span>
                                    </button>
                                </div>
                                <div v-else class="muted small">{{ t('schedule.noDays') }}</div>
                            </div>

                            <div class="card">
                                <h3 style="margin-top:0">{{ t('schedule.daysExercises') }}</h3>
                                <div v-if="days.length===0">{{ t('schedule.noDays') }}</div>
                                <div v-else class="day-list">
                                    <div v-for="d in days" :key="d.id" class="day-card" :id="'day-'+d.id">
                                        <div class="day-header">
                                            <div class="stack">
                                                <div class="meta">
                                                    <strong>{{ t('labels.weekNumber', { week: d.week }) }}</strong>
                                                    <span class="tag accent">{{ dayCodeLabel(d.day_code?.toUpperCase()) }}</span>
                                                    <span class="tag">{{ formatCount((d.day_exercises||[]).length, 'labels.exerciseCount', 'labels.exercisesCount') }}</span>
                                                </div>
                                                <div class="muted">{{ d.title || t('labels.untitled') }}</div>
                                            </div>
                                            <div class="inline-actions">
                                                <button class="small" type="button" @click="toggleDay(d)">{{ isDayOpen(d) ? t('actions.collapse') : t('actions.expand') }}</button>
                                                <button class="btn small" @click="saveDay(d)">{{ t('actions.save') }}</button>
                                                <button class="small" type="button" @click="resetDayEdit(d)">{{ t('actions.reset') }}</button>
                                                <button class="small" type="button" @click="deleteDay(d)" style="color:#fca5a5;border-color:#3b0f10;background:#1a0b0c">{{ t('actions.delete') }}</button>
                                            </div>
                                        </div>

                                        <div class="day-body" v-show="isDayOpen(d)">
                                            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px">
                                                <label class="small stack">
                                                    {{ t('labels.week') }}
                                                    <input type="number" min="1" v-model.number="dayEdits[d.id].week" />
                                                </label>
                                                <label class="small stack">
                                                    {{ t('labels.dayCode') }}
                                                    <input v-model="dayEdits[d.id].day_code" list="day-code-options" />
                                                </label>
                                                <label class="small stack">
                                                    {{ t('labels.title') }}
                                                    <input v-model="dayEdits[d.id].title" list="day-title-options" />
                                                </label>
                                            </div>
                                            <label class="small stack">
                                                {{ t('labels.notes') }}
                                                <textarea v-model="dayEdits[d.id].notes" :placeholder="t('placeholders.notesOptional')"></textarea>
                                            </label>

                                            <div v-if="(d.day_exercises||[]).length" class="list">
                                                <div v-for="ex in d.day_exercises" :key="ex.id" class="card small stack">
                                                    <div style="display:flex;justify-content:space-between;align-items:center;gap:6px;flex-wrap:wrap">
                                                        <strong>{{ ex.exercises?.name || t('labels.exercise') }}</strong>
                                                        <div style="display:flex;gap:6px;flex-wrap:wrap">
                                                            <button class="btn small" @click="saveDayExercise(ex)">{{ t('actions.save') }}</button>
                                                            <button class="small" type="button" @click="resetDayExerciseEdit(ex)">{{ t('actions.reset') }}</button>
                                                            <button class="small" type="button" @click="deleteDayExercise(ex)" style="color:#fca5a5;border-color:#3b0f10;background:#1a0b0c">{{ t('actions.delete') }}</button>
                                                        </div>
                                                    </div>
                                                    <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px">
                                                        <label class="small stack">
                                                            {{ t('labels.position') }}
                                                            <input type="number" min="1" v-model.number="dayExerciseEdits[ex.id].position" />
                                                        </label>
                                                        <label class="small stack">
                                                            {{ t('labels.notes') }}
                                                            <textarea v-model="dayExerciseEdits[ex.id].notes" :placeholder="t('placeholders.notesOptional')"></textarea>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card small" style="margin-top:8px">
                                                <h4 style="margin:0 0 6px">{{ t('schedule.addExercise') }}</h4>
                                                <div style="display:flex;flex-direction:column;gap:6px">
                                                    <label class="small stack">
                                                        {{ t('schedule.searchSelect') }}
                                                        <input v-model="exerciseSelection[d.id].query" @input="matchExercise(d)" :placeholder="t('placeholders.filterExercises')" :list="'dl-'+d.id">
                                                    </label>
                                                    <datalist :id="'dl-'+d.id">
                                                        <option v-for="opt in filteredExerciseOptions(d)" :key="opt.id" :value="opt.name"></option>
                                                    </datalist>
                                                    <div class="suggestions">
                                                        <span class="chip" v-for="opt in filteredExerciseOptions(d).slice(0,5)" :key="opt.id" @click="pickExercise(d, opt)">{{ opt.name }}</span>
                                                    </div>
                                                    <textarea v-model="exerciseSelection[d.id].notes" :placeholder="t('placeholders.notesOptionalShort')"></textarea>
                                                    <button class="btn small" @click="addExerciseToDay(d)" :disabled="addingExercise">{{ t('actions.add') }}</button>
                                                    <div class="muted small" v-if="!exerciseSelection[d.id].exercise_id">{{ t('schedule.exerciseHelp') }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <div class="col program-sidebar">
                <div class="card exercise-panel exercise-sidebar">
                    <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">{{ t('sections.exercises') }} <span class="pill">{{ t('labels.totalCount', { count: exerciseOptions.length }) }}</span></h2>
                    <div class="stack">
                        <form @submit.prevent="addExerciseDefinition" style="display:flex;flex-direction:column;gap:8px">
                            <label class="small" style="display:flex;flex-direction:column;gap:4px">
                                {{ t('labels.name') }}
                                <input v-model="newExerciseName" :placeholder="t('placeholders.exerciseExample')" required />
                            </label>
                            <div style="display:flex;gap:8px;flex-wrap:wrap">
                                <button class="btn small" type="submit" :disabled="savingExercise">{{ t('actions.addExercise') }}</button>
                            </div>
                            <div v-if="savingExercise" class="muted small">{{ t('status.savingExercise') }}</div>
                        </form>
                        <div>
                            <h3 style="margin-top:0">{{ t('exercises.available') }}</h3>
                            <div v-if="exerciseOptions.length===0" class="muted small">{{ t('exercises.none') }}</div>
                            <div v-else class="exercise-list scroll-area">
                                <div v-for="ex in exerciseOptions" :key="ex.id" class="exercise-item small">
                                    <div class="exercise-head">
                                        <input v-model="exerciseEdits[ex.id].name" :placeholder="t('placeholders.exerciseName')" />
                                        <span class="pill">#{{ ex.id.slice(0,4) }}</span>
                                    </div>
                                    <div class="exercise-actions">
                                        <button class="btn small icon-button" @click="updateExercise(ex)" :disabled="savingExercise" :title="t('actions.save')" :aria-label="t('actions.save')">üíæ</button>
                                        <button class="small icon-button danger" type="button" @click="deleteExercise(ex)" :disabled="savingExercise" :title="t('actions.delete')" :aria-label="t('actions.delete')">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vue 3 & Supabase JS v2 (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/vue@3.4.38/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
    // Fallback loader if CDNs are blocked
    (function(){
      function add(src){ var s=document.createElement('script'); s.src=src; s.crossOrigin='anonymous'; document.head.appendChild(s); }
      // Vue fallback
      window.addEventListener('error', function(){}, true);
      setTimeout(function(){
        if(!window.Vue){
          add('https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.38/vue.global.prod.min.js');
        }
        if(!window.supabase || !window.supabase.createClient){
          add('https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.45.4/supabase.min.js');
        }
      }, 300);
    })();
</script>
<script type="module" src="./supabase-bridge.js"></script>
<script src="./app.js"></script>
</body>
</html>
