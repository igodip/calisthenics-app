<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calisync Admin Portal</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
<div id="app" class="wrap">
    <div v-if="!session" class="card" style="max-width:460px;margin:60px auto;">
        <h1>Calisync Admin Portal</h1>
        <p class="muted">Sign in with your Supabase account to manage trainees, their workout days, and exercises.</p>
        <form @submit.prevent="emailPasswordSignIn" style="display:flex;flex-direction:column;gap:10px;margin-top:12px">
            <input v-model="email" type="email" placeholder="Email" required>
            <input v-model="password" type="password" placeholder="Password" required>
            <button class="btn">Sign in</button>
        </form>
    </div>

    <div v-else>
        <div class="toolbar">
            <div style="display:flex;align-items:center;gap:10px">
                <div class="pill">{{ user?.email }}</div>
                <span class="pill">Admin</span>
            </div>
            <div class="pill-menu">
                <button :class="{active: activeSection==='exercises'}" @click="activeSection='exercises'">Exercises</button>
                <button :class="{active: activeSection==='trainees'}" @click="activeSection='trainees'">Trainees</button>
                <button :class="{active: activeSection==='plans'}" @click="activeSection='plans'" :disabled="!current">Plans</button>
                <button :class="{active: activeSection==='schedule'}" @click="activeSection='schedule'" :disabled="!current">Schedule</button>
                <button :class="{active: activeSection==='history'}" @click="activeSection='history'" :disabled="!current">History</button>
            </div>
            <div class="toolbar-secondary">
                <input v-model="search" placeholder="Search trainees..." style="min-width:200px" />
                <button class="btn" @click="signOut">Sign out</button>
            </div>
        </div>

        <div class="card section-panel exercise-panel" :class="{active: activeSection==='exercises'}">
            <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">Exercises <span class="pill">{{ exerciseOptions.length }} total</span></h2>
            <div class="row">
                <div class="col">
                    <form @submit.prevent="addExerciseDefinition" style="display:flex;flex-direction:column;gap:8px">
                        <label class="small" style="display:flex;flex-direction:column;gap:4px">
                            Name
                            <input v-model="newExerciseName" placeholder="e.g. Push-ups" required />
                        </label>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button class="btn small" type="submit" :disabled="savingExercise">Add exercise</button>
                            <button class="small" type="button" @click="resetExerciseForm" :disabled="savingExercise">Reset</button>
                        </div>
                        <div v-if="savingExercise" class="muted small">Saving exercise…</div>
                    </form>
                </div>
                <div class="col">
                    <h3 style="margin-top:0">Available exercises</h3>
                    <div v-if="exerciseOptions.length===0" class="muted small">No exercises loaded yet.</div>
                    <div v-else class="exercise-list scroll-area">
                        <div v-for="ex in exerciseOptions" :key="ex.id" class="exercise-item small">
                            <div class="exercise-head">
                                <input v-model="exerciseEdits[ex.id].name" placeholder="Exercise name" />
                                <span class="pill">#{{ ex.id.slice(0,4) }}</span>
                            </div>
                            <div class="exercise-actions">
                                <button class="btn small" @click="updateExercise(ex)" :disabled="savingExercise">Save</button>
                                <button class="small" type="button" @click="resetExerciseEdit(ex)" :disabled="savingExercise">Reset</button>
                                <button class="small" type="button" @click="deleteExercise(ex)" :disabled="savingExercise" style="color:#fca5a5;border-color:#3b0f10;background:#1a0b0c">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row section-panel" :class="{active: activeSection==='trainees'}">
            <div class="col">
                <div class="card">
                    <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                        Trainees
                        <span class="pill">{{ filteredUsers.length }} shown</span>
                    </h2>
                    <div class="muted small" v-if="loadingProgress">Refreshing progress…</div>
                    <div class="list scroll-area">
                        <div v-for="u in filteredUsers" :key="u.id" class="card" style="padding:12px">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                                <div>
                                    <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                    <div class="muted small mono">{{ u.id }}</div>
                                </div>
                                <span class="badge">trainee</span>
                            </div>
                            <div class="progress-row" v-if="progressFor(u).total">
                                <div class="progress-bar">
                                    <span :style="{ width: progressFor(u).percent + '%' }"></span>
                                </div>
                                <div class="progress-meta small">
                                    <span>{{ progressFor(u).percent }}%</span>
                                    <span class="muted">{{ progressFor(u).completed }}/{{ progressFor(u).total }}</span>
                                </div>
                            </div>
                            <div class="muted small" v-else>No progress logged yet.</div>
                            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                                <button class="btn" @click="selectUser(u); activeSection='schedule'">Open schedule</button>
                                <button class="btn" @click="loadDays(u); activeSection='schedule'">Load days</button>
                                <button class="btn" @click="loadPlans(u); activeSection='plans'">Load plans</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row section-panel" :class="{active: activeSection==='plans'}">
            <div class="col" v-if="!current">
                <div class="card">
                    <h2>Workout plans</h2>
                    <p class="muted">Select a trainee from the Trainees tab to manage their plans.</p>
                </div>
            </div>

            <div class="col" v-else>
                <div class="card">
                    <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">Add workout plan <span class="pill">{{ current.displayName || shortId(current.id) }}</span></h2>
                    <form @submit.prevent="addPlan" style="display:flex;flex-direction:column;gap:8px">
                        <label class="small stack">
                            Name
                            <input v-model="newPlanName" placeholder="e.g. Summer Strength" required />
                        </label>
                        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
                            <label class="small stack">
                                Status
                                <select v-model="newPlanStatus">
                                    <option v-for="status in planStatuses" :key="status" :value="status">{{ status }}</option>
                                </select>
                            </label>
                            <label class="small stack">
                                Starts at
                                <input type="date" v-model="newPlanStartsAt" />
                            </label>
                            <label class="small stack">
                                Ends at
                                <input type="date" v-model="newPlanEndsAt" />
                            </label>
                        </div>
                        <label class="small stack">
                            Notes
                            <textarea v-model="newPlanNotes" placeholder="Optional notes for the trainee"></textarea>
                        </label>
                        <div style="display:flex;gap:8px;flex-wrap:wrap">
                            <button class="btn small" type="submit" :disabled="savingPlan">Save plan</button>
                            <button class="small" type="button" @click="resetPlanForm" :disabled="savingPlan">Reset</button>
                        </div>
                        <div v-if="savingPlan" class="muted small">Saving plan…</div>
                    </form>
                </div>

                <div class="card">
                    <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">Plans <span class="pill">{{ plans.length }} total</span></h2>
                    <div v-if="plans.length===0" class="muted small">No plans for this trainee yet.</div>
                    <div v-else class="list scroll-area">
                        <div v-for="plan in plans" :key="plan.id" class="card stack small">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
                                <div class="stack">
                                    <strong>{{ planEdits[plan.id]?.name || plan.name }}</strong>
                                    <span class="muted mono small">#{{ shortId(plan.id) }}</span>
                                </div>
                                <div class="inline-actions">
                                    <button class="btn small" @click="savePlan(plan)" :disabled="savingPlan">Save</button>
                                    <button class="small" type="button" @click="resetPlanEdit(plan)" :disabled="savingPlan">Reset</button>
                                    <button class="small" type="button" @click="deletePlan(plan)" :disabled="savingPlan" style="color:#fca5a5;border-color:#3b0f10;background:#1a0b0c">Delete</button>
                                </div>
                            </div>
                            <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px">
                                <label class="small stack">
                                    Name
                                    <input v-model="planEdits[plan.id].name" />
                                </label>
                                <label class="small stack">
                                    Status
                                    <select v-model="planEdits[plan.id].status">
                                        <option v-for="status in planStatuses" :key="status" :value="status">{{ status }}</option>
                                    </select>
                                </label>
                                <label class="small stack">
                                    Starts at
                                    <input type="date" v-model="planEdits[plan.id].starts_on" />
                                </label>
                            </div>
                            <label class="small stack">
                                Notes
                                <textarea v-model="planEdits[plan.id].notes" placeholder="Optional notes"></textarea>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row section-panel" :class="{active: activeSection==='schedule'}">
            <div class="col" v-if="!current">
                <div class="card">
                    <h2>Schedule</h2>
                    <p class="muted">Pick a trainee from the Trainees tab to manage their schedule.</p>
                </div>
            </div>

            <div class="col" v-if="current">
                <div class="card">
                    <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">Schedule • {{ current.displayName || shortId(current.id) }} <span class="pill">{{ days.length }} days</span></h2>
                    <div class="grid">
                        <div class="card day-form-card">
                            <div class="day-form-header">
                                <h3 style="margin:0">Create day</h3>
                                <span class="pill">Next: week {{ nextWeek }}</span>
                            </div>
                            <div class="inline-actions">
                                <button class="small" type="button" @click="applyNextWeek">Use next week</button>
                                <button class="small" type="button" @click="resetDayForm" :disabled="addingDay">Clear</button>
                            </div>
                            <form @submit.prevent="addDay" class="stack">
                                <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
                                    <label class="small stack">
                                        Week
                                        <input type="number" min="1" v-model.number="newDayWeek" required>
                                    </label>
                                    <label class="small stack">
                                        Day code
                                        <select v-model="newDayCode" required>
                                            <option v-for="code in dayCodeOptions" :key="code" :value="code">{{ code }}</option>
                                        </select>
                                    </label>
                                    <label class="small stack">
                                        Title
                                        <input v-model="newDayTitle" placeholder="Workout title">
                                    </label>
                                </div>
                                <div class="stack">
                                    <span class="small">Quick day pick</span>
                                    <div class="day-code-picker">
                                        <button v-for="code in dayCodeOptions" :key="code" type="button" :class="{active: newDayCode === code}" @click="setDayCode(code)">{{ code }}</button>
                                    </div>
                                    <span class="helper-text">Tap a code to fill the day quickly.</span>
                                </div>
                                <label class="small stack">
                                    Notes
                                    <textarea v-model="newDayNotes" placeholder="Optional notes"></textarea>
                                </label>
                                <div style="display:flex;gap:8px;flex-wrap:wrap">
                                    <button class="btn small" type="submit" :disabled="addingDay">Save day</button>
                                    <button class="small" type="button" @click="resetDayForm" :disabled="addingDay">Reset</button>
                                </div>
                                <div v-if="addingDay" class="muted small">Saving day…</div>
                            </form>
                        </div>

                        <div class="card">
                            <h3 style="margin-top:0">Days & Exercises</h3>
                            <div v-if="days.length===0">No days yet.</div>
                            <div v-else class="day-list scroll-area">
                                <div v-for="d in days" :key="d.id" class="day-card">
                                    <div class="day-header">
                                        <div class="stack">
                                            <div class="meta">
                                                <strong>Week {{ d.week }}</strong>
                                                <span class="tag accent">{{ d.day_code?.toUpperCase() }}</span>
                                                <span class="tag">{{ (d.day_exercises||[]).length }} exercises</span>
                                            </div>
                                            <div class="muted">{{ d.title || 'Untitled' }}</div>
                                        </div>
                                        <div class="inline-actions">
                                            <button class="small" type="button" @click="toggleDay(d)">{{ isDayOpen(d) ? 'Collapse' : 'Expand' }}</button>
                                            <button class="btn small" @click="saveDay(d)">Save</button>
                                            <button class="small" type="button" @click="resetDayEdit(d)">Reset</button>
                                            <button class="small" type="button" @click="deleteDay(d)" style="color:#fca5a5;border-color:#3b0f10;background:#1a0b0c">Delete</button>
                                        </div>
                                    </div>

                                    <div class="day-body" v-show="isDayOpen(d)">
                                        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px">
                                            <label class="small stack">
                                                Week
                                                <input type="number" min="1" v-model.number="dayEdits[d.id].week" />
                                            </label>
                                            <label class="small stack">
                                                Day code
                                                <input v-model="dayEdits[d.id].day_code" />
                                            </label>
                                            <label class="small stack">
                                                Title
                                                <input v-model="dayEdits[d.id].title" />
                                            </label>
                                        </div>
                                        <label class="small stack">
                                            Notes
                                            <textarea v-model="dayEdits[d.id].notes" placeholder="Optional notes"></textarea>
                                        </label>

                                        <div v-if="(d.day_exercises||[]).length" class="list">
                                            <div v-for="ex in d.day_exercises" :key="ex.id" class="card small stack">
                                                <div style="display:flex;justify-content:space-between;align-items:center;gap:6px;flex-wrap:wrap">
                                                    <strong>{{ ex.exercises?.name || 'Exercise' }}</strong>
                                                    <div style="display:flex;gap:6px;flex-wrap:wrap">
                                                        <button class="btn small" @click="saveDayExercise(ex)">Save</button>
                                                        <button class="small" type="button" @click="resetDayExerciseEdit(ex)">Reset</button>
                                                        <button class="small" type="button" @click="deleteDayExercise(ex)" style="color:#fca5a5;border-color:#3b0f10;background:#1a0b0c">Delete</button>
                                                    </div>
                                                </div>
                                                <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px">
                                                    <label class="small stack">
                                                        Position
                                                        <input type="number" min="1" v-model.number="dayExerciseEdits[ex.id].position" />
                                                    </label>
                                                    <label class="small stack">
                                                        Notes
                                                        <textarea v-model="dayExerciseEdits[ex.id].notes" placeholder="Optional notes"></textarea>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card small" style="margin-top:8px">
                                            <h4 style="margin:0 0 6px">Add exercise</h4>
                                            <div style="display:flex;flex-direction:column;gap:6px">
                                                <label class="small stack">
                                                    Search & select
                                                    <input v-model="exerciseSelection[d.id].query" @input="matchExercise(d)" placeholder="Type to filter exercises" :list="'dl-'+d.id">
                                                </label>
                                                <datalist :id="'dl-'+d.id">
                                                    <option v-for="opt in filteredExerciseOptions(d)" :key="opt.id" :value="opt.name"></option>
                                                </datalist>
                                                <div class="suggestions">
                                                    <span class="chip" v-for="opt in filteredExerciseOptions(d).slice(0,5)" :key="opt.id" @click="pickExercise(d, opt)">{{ opt.name }}</span>
                                                </div>
                                                <textarea v-model="exerciseSelection[d.id].notes" placeholder="Notes (optional)"></textarea>
                                                <button class="btn small" @click="addExerciseToDay(d)" :disabled="addingExercise">Add</button>
                                                <div class="muted small" v-if="!exerciseSelection[d.id].exercise_id">Start typing to auto-complete and click a suggestion.</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row section-panel" :class="{active: activeSection==='history'}">
            <div class="col" v-if="!current">
                <div class="card">
                    <h2>Max test history</h2>
                    <p class="muted">Select a trainee from the Trainees tab to review their max test history.</p>
                </div>
            </div>

            <div class="col" v-else>
                <div class="card">
                    <div class="history-header">
                        <h2 style="margin:0">Max test history • {{ current.displayName || shortId(current.id) }}</h2>
                        <div class="inline-actions">
                            <span class="pill">{{ maxTests.length }} tests</span>
                            <button class="small" type="button" @click="loadMaxTests" :disabled="loadingMaxTests">Refresh</button>
                        </div>
                    </div>
                    <p class="muted small">Each chart shows how max attempts evolve over time for a single exercise.</p>
                    <div v-if="loadingMaxTests" class="muted small">Loading max tests…</div>
                    <div v-else-if="maxTestsError" class="muted small">{{ maxTestsError }}</div>
                    <div v-else-if="maxTests.length===0" class="muted small">No max tests logged yet.</div>
                    <div v-else class="history-grid">
                        <div v-for="entry in maxTestHistory" :key="entry.exercise" class="card history-card">
                            <div class="history-card-head">
                                <div class="stack">
                                    <strong>{{ entry.exercise }}</strong>
                                    <span class="muted small">{{ entry.count }} tests • best {{ formatTestValue(entry.bestValue) }} {{ entry.unit }}</span>
                                </div>
                                <span class="pill">{{ entry.latestLabel }}</span>
                            </div>
                            <div class="history-chart-wrap">
                                <div class="history-y-axis small">
                                    <span>{{ formatTestValue(entry.maxValue) }} {{ entry.unit }}</span>
                                    <span>{{ formatTestValue(entry.minValue) }} {{ entry.unit }}</span>
                                </div>
                                <svg
                                    class="history-chart"
                                    :viewBox="`0 0 ${entry.chartWidth} ${entry.chartHeight}`"
                                    role="img"
                                    :aria-label="`Max test history for ${entry.exercise}`"
                                >
                                    <polyline :points="entry.polyline" class="history-line"></polyline>
                                    <circle
                                        v-for="(point, idx) in entry.points"
                                        :key="idx"
                                        :cx="point.x"
                                        :cy="point.y"
                                        class="history-point"
                                        :class="{ latest: idx === entry.points.length - 1 }"
                                    ></circle>
                                </svg>
                            </div>
                            <div class="history-meta small">
                                <span>{{ entry.minDateLabel }}</span>
                                <span>{{ entry.maxDateLabel }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vue 3 & Supabase JS v2 (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/vue@3.4.38/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
    // Fallback loader if CDNs are blocked
    (function(){
      function add(src){ var s=document.createElement('script'); s.src=src; s.crossOrigin='anonymous'; document.head.appendChild(s); }
      // Vue fallback
      window.addEventListener('error', function(){}, true);
      setTimeout(function(){
        if(!window.Vue){
          add('https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.38/vue.global.prod.min.js');
        }
        if(!window.supabase || !window.supabase.createClient){
          add('https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.45.4/supabase.min.js');
        }
      }, 300);
    })();
</script>
<script type="module" src="./supabase-bridge.js"></script>
<script src="./app.js"></script>
</body>
</html>
