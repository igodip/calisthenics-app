<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calisync Admin Portal</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
<div id="app" class="wrap">
    <div v-if="!session" class="card" style="max-width:460px;margin:60px auto;">
        <h1>{{ t('app.title') }}</h1>
        <p class="muted">{{ t('auth.subtitle') }}</p>
        <form @submit.prevent="emailPasswordSignIn" style="display:flex;flex-direction:column;gap:10px;margin-top:12px">
            <input v-model="email" type="email" :placeholder="t('placeholders.email')" required>
            <input v-model="password" type="password" :placeholder="t('placeholders.password')" required>
            <button class="btn">{{ t('actions.signIn') }}</button>
        </form>
    </div>

    <div v-else>
        <div class="toolbar">
            <div style="display:flex;align-items:center;gap:10px">
                <div class="pill">{{ user?.email }}</div>
                <span class="pill">{{ roleLabel }}</span>
            </div>
            <div class="pill-menu">
                <button :class="{active: activeSection==='dashboard'}" @click="activeSection='dashboard'">{{ t('sections.dashboard') }}</button>
                <button :class="{active: activeSection==='trainees'}" @click="activeSection='trainees'">{{ t('sections.trainees') }}</button>
                <button :class="{active: activeSection==='payments'}" @click="activeSection='payments'">{{ t('sections.payments') }}</button>
                <button :class="{active: activeSection==='program'}" @click="activeSection='program'">{{ t('sections.program') }}</button>
            </div>
            <div class="toolbar-secondary">
                <select v-model="locale" class="pill" :aria-label="t('toolbar.language')">
                    <option v-for="option in languageOptions" :key="option.value" :value="option.value">{{ option.label }}</option>
                </select>
                <input v-model="search" :placeholder="t('toolbar.searchPlaceholder')" style="min-width:200px" />
                <button class="btn" @click="signOut">{{ t('actions.signOut') }}</button>
            </div>
        </div>

        <div class="section-panel dashboard-panel" :class="{active: activeSection==='dashboard'}">
            <div class="dashboard-grid">
                <div class="card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('dashboard.feedbackTitle') }}</h2>
                            <span class="muted small">{{ t('dashboard.feedbackSubtitle') }}</span>
                        </div>
                        <button class="small" type="button" @click="loadDashboardNotes" :disabled="dashboardNotesLoading">{{ t('actions.refresh') }}</button>
                    </div>
                    <div v-if="dashboardNotesLoading" class="muted small">{{ t('dashboard.loadingFeedback') }}</div>
                    <div v-else-if="dashboardNotesError" class="muted small">{{ dashboardNotesError }}</div>
                    <div v-else-if="dashboardNotes.length===0" class="muted small">{{ t('dashboard.noFeedback') }}</div>
                    <div v-else class="chat-list">
                        <div v-for="note in dashboardNotes" :key="note.id" class="chat-item">
                            <div class="chat-meta">
                                <strong>{{ note.traineeName }}</strong>
                                <div class="chat-actions">
                                    <span class="pill">{{ note.statusLabel }}</span>
                                    <button
                                        v-if="!note.isRead"
                                        class="small"
                                        type="button"
                                        :disabled="dashboardNotesSaving[note.id]"
                                        @click="markFeedbackRead(note)"
                                    >
                                        {{ t('actions.markRead') }}
                                    </button>
                                </div>
                            </div>
                            <div class="muted small" v-if="note.dateLabel">{{ note.dateLabel }}</div>
                            <div class="chat-message">{{ note.message }}</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('dashboard.generalTitle') }}</h2>
                            <span class="muted small">{{ t('dashboard.generalSubtitle') }}</span>
                        </div>
                        <span class="pill">{{ t('labels.shownCount', { count: dashboardTrainees.length }) }}</span>
                    </div>
                    <div v-if="dashboardTrainees.length===0" class="muted small" style="margin-top:10px">
                        {{ t('dashboard.generalEmpty') }}
                    </div>
                    <div v-else class="dashboard-trainee-list scroll-area">
                        <div class="dashboard-trainee-item" v-for="u in dashboardTrainees" :key="u.id">
                            <div class="stack">
                                <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                <span class="muted small mono">{{ u.id }}</span>
                            </div>
                            <div class="stack dashboard-trainee-actions">
                                <span class="pill" :class="u.paid ? 'paid' : 'overdue'">
                                    {{ u.paid ? t('payment.onTime') : t('payment.overdue') }}
                                </span>
                                <button class="small" type="button" @click="openTrainee(u)">{{ t('actions.openTrainee') }}</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="row section-panel" :class="{active: activeSection==='trainees'}">
            <div class="col">
                <div class="card">
                    <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                        {{ t('sections.trainees') }}
                        <span class="pill">{{ t('labels.shownCount', { count: filteredUsers.length }) }}</span>
                    </h2>
                    <div class="muted small" v-if="loadingProgress">{{ t('status.refreshingProgress') }}</div>
                    <div class="list scroll-area">
                        <div v-for="u in filteredUsers" :key="u.id" class="card" style="padding:12px">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                                <div>
                                    <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                    <div class="muted small mono">{{ u.id }}</div>
                                </div>
                                <span class="badge">{{ t('trainees.badge') }}</span>
                            </div>
                            <div class="progress-row" v-if="progressFor(u).total">
                                <div class="progress-bar">
                                    <span :style="{ width: progressFor(u).percent + '%' }"></span>
                                </div>
                                <div class="progress-meta small">
                                    <span>{{ progressFor(u).percent }}%</span>
                                    <span class="muted">{{ progressFor(u).completed }}/{{ progressFor(u).total }}</span>
                                </div>
                            </div>
                            <div class="muted small" v-else>{{ t('status.noProgress') }}</div>
                            <div class="trainer-row">
                                <span class="muted small">{{ t('trainers.assigned') }}</span>
                                <div class="trainer-tags">
                                    <span v-if="!u.trainers || u.trainers.length===0" class="muted small">
                                        {{ t('trainers.none') }}
                                    </span>
                                    <span v-else v-for="trainer in u.trainers" :key="trainer.id" class="pill trainer-pill">
                                        {{ trainer.name }}
                                        <button
                                            v-if="canAssignTrainers"
                                            class="icon-button"
                                            type="button"
                                            @click="removeTrainerAssignment(u, trainer)"
                                            :aria-label="t('actions.delete')"
                                        >
                                            ×
                                        </button>
                                    </span>
                                </div>
                            </div>
                            <div v-if="canAssignTrainers" class="trainer-assign">
                                <select v-model="trainerSelections[u.id]">
                                    <option value="">{{ t('trainers.select') }}</option>
                                    <option
                                        v-for="trainer in trainers"
                                        :key="trainer.id"
                                        :value="trainer.id"
                                        :disabled="u.trainerIds && u.trainerIds.includes(trainer.id)"
                                    >
                                        {{ trainer.name }}
                                    </option>
                                </select>
                                <button
                                    class="small"
                                    type="button"
                                    :disabled="trainerAssignmentSaving[u.id] || !trainerSelections[u.id]"
                                    @click="assignTrainerToTrainee(u)"
                                >
                                    {{ t('actions.assignTrainer') }}
                                </button>
                            </div>
                            <div class="payment-row">
                                <span class="pill" :class="u.paid ? 'paid' : 'overdue'">
                                    {{ u.paid ? t('payment.onTime') : t('payment.overdue') }}
                                </span>
                                <label class="payment-toggle small">
                                    <input
                                        type="checkbox"
                                        :checked="u.paid"
                                        :disabled="paymentSaving[u.id]"
                                        @change="togglePayment(u, $event)"
                                    />
                                    <span>{{ t('payment.toggle') }}</span>
                                </label>
                            </div>
                            <div class="muted small" v-if="paymentSaving[u.id]">{{ t('status.updatingPayment') }}</div>
                            <div class="muted small" v-if="trainerAssignmentSaving[u.id]">{{ t('status.updatingTrainer') }}</div>
                            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                                <button class="btn" @click="openTrainee(u)">{{ t('actions.openTrainee') }}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-panel payments-panel" :class="{active: activeSection==='payments'}">
            <div class="dashboard-grid payments-grid">
                <div class="card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('payments.overviewTitle') }}</h2>
                            <span class="muted small">{{ t('payments.overviewSubtitle') }}</span>
                        </div>
                        <span class="pill">{{ t('labels.shownCount', { count: paymentUsers.length }) }}</span>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span class="summary-label">{{ t('payments.totalLabel') }}</span>
                            <strong>{{ paymentSummary.total }}</strong>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">{{ t('payments.paidLabel') }}</span>
                            <strong>{{ paymentSummary.paid }}</strong>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">{{ t('payments.overdueLabel') }}</span>
                            <strong>{{ paymentSummary.overdue }}</strong>
                        </div>
                    </div>
                    <div class="filter-row">
                        <button
                            v-for="filter in paymentFilterOptions"
                            :key="filter.value"
                            type="button"
                            :class="{active: paymentFilter===filter.value}"
                            @click="paymentFilter=filter.value"
                        >
                            {{ t(filter.labelKey) }}
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('payments.overdueTitle') }}</h2>
                            <span class="muted small">{{ t('payments.overdueSubtitle') }}</span>
                        </div>
                    </div>
                    <div v-if="overdueUsers.length===0" class="muted small">{{ t('payments.noOverdue') }}</div>
                    <div v-else class="list">
                        <div v-for="u in overdueUsers" :key="u.id" class="payment-alert">
                            <div class="stack">
                                <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                <span class="muted small mono">{{ u.id }}</span>
                            </div>
                            <div class="inline-actions">
                                <button class="small" type="button" :disabled="paymentSaving[u.id]" @click="markPaymentPaid(u)">
                                    {{ t('payments.markPaid') }}
                                </button>
                                <button class="small" type="button" @click="openTrainee(u)">{{ t('dashboard.openProgram') }}</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card payments-manage-card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('payments.manageTitle') }}</h2>
                            <span class="muted small">{{ t('payments.manageSubtitle') }}</span>
                        </div>
                    </div>
                    <div v-if="paymentUsers.length===0" class="muted small">{{ t('payments.noMatches') }}</div>
                    <div v-else class="list scroll-area payments-list">
                        <div v-for="u in paymentUsers" :key="u.id" class="card payment-card">
                            <div class="payment-card-header">
                                <div class="stack">
                                    <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                    <span class="muted small mono">{{ u.id }}</span>
                                </div>
                                <span class="pill" :class="u.paid ? 'paid' : 'overdue'">
                                    {{ u.paid ? t('payment.onTime') : t('payment.overdue') }}
                                </span>
                            </div>
                            <div class="payment-actions">
                                <label class="payment-toggle small">
                                    <input
                                        type="checkbox"
                                        :checked="u.paid"
                                        :disabled="paymentSaving[u.id]"
                                        @change="togglePayment(u, $event)"
                                    />
                                    <span>{{ t('payment.toggle') }}</span>
                                </label>
                                <button class="small" type="button" @click="openTrainee(u)">{{ t('actions.openTrainee') }}</button>
                            </div>
                            <div class="muted small" v-if="paymentSaving[u.id]">{{ t('status.updatingPayment') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row section-panel program-panel" :class="{active: activeSection==='program'}">
            <div class="col program-main">
                <div class="card" v-if="!current">
                    <h2>{{ t('program.title') }}</h2>
                    <p class="muted">{{ t('program.empty') }}</p>
                </div>

                <template v-else>
                    <div class="card">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('program.titleWithName', { name: current.displayName || shortId(current.id) }) }}</h2>
                            <p class="muted">{{ t('program.subtitle') }}</p>
                        </div>
                    </div>

                    <div class="overview-grid">
                        <div class="card">
                            <div class="overview-card-header">
                                <div class="stack">
                                    <h3 style="margin:0">{{ t('program.calendarTitle') }}</h3>
                                    <span class="muted small">{{ t('program.calendarSubtitle') }}</span>
                                </div>
                                <button class="small" type="button" @click="loadDays">{{ t('actions.refresh') }}</button>
                            </div>
                            <div v-if="trainingCalendar.length===0" class="muted small">{{ t('program.calendarEmpty') }}</div>
                            <div v-else class="calendar-grid">
                                <div v-for="entry in trainingCalendar" :key="entry.id" class="calendar-item" :class="{trained: entry.trained}">
                                    <div class="stack">
                                        <strong>{{ entry.label }}</strong>
                                        <span v-if="entry.total" class="muted small">{{ t('program.calendarExercises', { completed: entry.completed, total: entry.total }) }}</span>
                                        <span v-else class="muted small">{{ t('program.calendarNoExercises') }}</span>
                                    </div>
                                    <span class="tag" :class="{accent: entry.trained}">
                                        {{ entry.trained ? t('program.calendarTrained') : t('program.calendarNoTraining') }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="overview-card-header">
                                <div class="stack">
                                    <h3 style="margin:0">{{ t('program.dataTitle') }}</h3>
                                    <span class="muted small">{{ t('program.dataSubtitle') }}</span>
                                </div>
                                <button class="small" type="button" @click="openTrainee(current)">{{ t('actions.refresh') }}</button>
                            </div>
                            <div class="data-list">
                                <div class="data-row">
                                    <span class="muted small">{{ t('labels.name') }}</span>
                                    <strong>{{ current.displayName || shortId(current.id) }}</strong>
                                </div>
                                <div class="data-row">
                                    <span class="muted small">{{ t('labels.id') }}</span>
                                    <span class="mono">{{ current.id }}</span>
                                </div>
                                <div class="data-row">
                                    <span class="muted small">{{ t('trainers.assigned') }}</span>
                                    <div class="data-chips" v-if="current.trainers && current.trainers.length">
                                        <span v-for="trainer in current.trainers" :key="trainer.id" class="pill">{{ trainer.name }}</span>
                                    </div>
                                    <span v-else class="muted small">{{ t('trainers.none') }}</span>
                                </div>
                                <div class="data-row">
                                    <span class="muted small">{{ t('program.paymentStatus') }}</span>
                                    <span class="pill" :class="current.paid ? 'paid' : 'overdue'">
                                        {{ current.paid ? t('payment.onTime') : t('payment.overdue') }}
                                    </span>
                                </div>
                                <div class="data-row">
                                    <span class="muted small">{{ t('program.progressLabel') }}</span>
                                    <span>
                                        {{ progressFor(current).percent }}% ({{ progressFor(current).completed }}/{{ progressFor(current).total }})
                                    </span>
                                </div>
                            </div>
                            <div class="data-block">
                                <span class="muted small">{{ t('program.maxTestsTitle') }}</span>
                                <div v-if="loadingMaxTests" class="muted small">{{ t('status.loadingMaxTests') }}</div>
                                <div v-else-if="maxTestsError" class="muted small">{{ maxTestsError }}</div>
                                <div v-else-if="maxTestHistory.length===0" class="muted small">{{ t('history.none') }}</div>
                                <div v-else class="data-chips">
                                    <span v-for="item in maxTestHistory" :key="item.exercise" class="pill">
                                        {{ item.exercise }} • {{ formatTestValue(item.bestValue) }} {{ item.unit }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overview-grid">
                        <div class="card">
                            <div class="overview-card-header">
                                <div class="stack">
                                    <h3 style="margin:0">{{ t('program.plansTitle') }}</h3>
                                    <span class="muted small">{{ t('program.plansSubtitle') }}</span>
                                </div>
                                <button class="small" type="button" @click="loadPlans">{{ t('actions.refresh') }}</button>
                            </div>
                            <div v-if="plans.length===0" class="muted small">{{ t('plans.none') }}</div>
                            <div v-else class="list">
                                <div v-for="plan in plans" :key="plan.id" class="plan-item">
                                    <div class="stack">
                                        <strong>{{ plan.title }}</strong>
                                        <span class="muted small">{{ planStatusLabel(plan.status) }}</span>
                                        <span class="muted small" v-if="plan.starts_on">{{ t('labels.startsAt') }}: {{ plan.starts_on }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="overview-card-header">
                                <div class="stack">
                                    <h3 style="margin:0">{{ t('program.paymentsTitle') }}</h3>
                                    <span class="muted small">{{ t('program.paymentsSubtitle') }}</span>
                                </div>
                                <button class="small" type="button" @click="loadPaymentHistory">{{ t('actions.refresh') }}</button>
                            </div>
                            <div v-if="loadingPayments" class="muted small">{{ t('status.loadingPayments') }}</div>
                            <div v-else-if="paymentsError" class="muted small">{{ paymentsError }}</div>
                            <div v-else-if="paymentHistory.length===0" class="muted small">{{ t('program.paymentsEmpty') }}</div>
                            <div v-else class="list">
                                <div v-for="payment in paymentHistory" :key="payment.id" class="payment-history-item">
                                    <div class="stack">
                                        <strong>{{ formatDate(payment.month_start) }}</strong>
                                        <span class="muted small" v-if="payment.paid_at">{{ t('program.paidAt', { date: formatDate(payment.paid_at) }) }}</span>
                                    </div>
                                    <span class="pill" :class="payment.paid ? 'paid' : 'overdue'">
                                        {{ payment.paid ? t('payment.onTime') : t('payment.overdue') }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

        </div>
    </div>
</div>

<!-- Vue 3 & Supabase JS v2 (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/vue@3.4.38/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
    // Fallback loader if CDNs are blocked
    (function(){
      function add(src){ var s=document.createElement('script'); s.src=src; s.crossOrigin='anonymous'; document.head.appendChild(s); }
      // Vue fallback
      window.addEventListener('error', function(){}, true);
      setTimeout(function(){
        if(!window.Vue){
          add('https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.38/vue.global.prod.min.js');
        }
        if(!window.supabase || !window.supabase.createClient){
          add('https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.45.4/supabase.min.js');
        }
      }, 300);
    })();
</script>
<script type="module" src="./supabase-bridge.js"></script>
<script type="module" src="./app.js"></script>
</body>
</html>
