<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Calisync Admin Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
<div id="app" class="wrap">
    <div v-if="!session" class="auth-shell">
        <div class="auth-card">
            <div class="brand">
                <span class="brand-mark">C</span>
                <div>
                    <h1>{{ t('app.title') }}</h1>
                    <p class="muted">{{ t('auth.subtitle') }}</p>
                </div>
            </div>
            <form class="auth-form" @submit.prevent="emailPasswordSignIn">
                <label class="field">
                    <span class="label">{{ t('placeholders.email') }}</span>
                    <input v-model="email" type="email" :placeholder="t('placeholders.email')" required>
                </label>
                <label class="field">
                    <span class="label">{{ t('placeholders.password') }}</span>
                    <input v-model="password" type="password" :placeholder="t('placeholders.password')" required>
                </label>
                <button class="btn primary">{{ t('actions.signIn') }}</button>
            </form>
        </div>
    </div>

    <div v-else class="app-shell">
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="brand-mark">C</span>
                <div>
                    <div class="brand-title">Calisync</div>
                    <div class="muted small">{{ t('app.title') }}</div>
                </div>
            </div>
            <nav class="nav">
                <button :class="{active: activeSection==='dashboard'}" @click="activeSection='dashboard'">
                    <span>{{ t('sections.dashboard') }}</span>
                    <span class="nav-badge">{{ dashboardNotes.length }}</span>
                </button>
                <button :class="{active: activeSection==='trainees'}" @click="activeSection='trainees'">
                    <span>{{ t('sections.trainees') }}</span>
                    <span class="nav-badge">{{ filteredUsers.length }}</span>
                </button>
                <button :class="{active: activeSection==='payments'}" @click="activeSection='payments'">
                    <span>{{ t('sections.payments') }}</span>
                    <span class="nav-badge">{{ paymentUsers.length }}</span>
                </button>
                <button :class="{active: activeSection==='program'}" @click="activeSection='program'">
                    <span>{{ t('sections.program') }}</span>
                    <span class="nav-badge">{{ current ? 1 : 0 }}</span>
                </button>
                <button :class="{active: activeSection==='exercises'}" @click="activeSection='exercises'">
                    <span>{{ t('sections.exercises') }}</span>
                    <span class="nav-badge">{{ exercises.length }}</span>
                </button>
                <button :class="{active: activeSection==='terminology'}" @click="activeSection='terminology'">
                    <span>{{ t('sections.terminology') }}</span>
                    <span class="nav-badge">{{ terminology.length }}</span>
                </button>
            </nav>
            <div class="sidebar-footer">
                <div class="user-chip">
                    <div class="avatar">{{ (user?.email || '?').slice(0, 1).toUpperCase() }}</div>
                    <div>
                        <div class="user-email">{{ user?.email }}</div>
                        <div class="muted small">{{ roleLabel }}</div>
                    </div>
                </div>
                <button class="btn ghost" @click="signOut">{{ t('actions.signOut') }}</button>
            </div>
        </aside>

        <main class="main">
            <div class="topbar">
                <div>
                    <div class="eyebrow">{{ t(`sections.${activeSection}`) }}</div>
                    <h2 class="page-title">{{ t('app.title') }}</h2>
                </div>
                <div class="toolbar-secondary">
                    <label class="search-field">
                        <span class="muted small">{{ t('toolbar.searchPlaceholder') }}</span>
                        <input v-model="search" :placeholder="t('toolbar.searchPlaceholder')" />
                    </label>
                    <select v-model="locale" class="pill" :aria-label="t('toolbar.language')">
                        <option v-for="option in languageOptions" :key="option.value" :value="option.value">{{ option.label }}</option>
                    </select>
                    <button class="btn soft" @click="signOut">{{ t('actions.signOut') }}</button>
                </div>
            </div>

            <div class="section-panel dashboard-panel" :class="{active: activeSection==='dashboard'}">
                <div class="hero-grid">
                    <div class="hero-card">
                        <div>
                            <div class="muted small">{{ t('dashboard.generalTitle') }}</div>
                            <h3>{{ t('labels.shownCount', { count: dashboardTrainees.length }) }}</h3>
                        </div>
                        <span class="hero-pill">{{ t('sections.trainees') }}</span>
                    </div>
                    <div class="hero-card">
                        <div>
                            <div class="muted small">{{ t('payments.overviewTitle') }}</div>
                            <h3>{{ paymentSummary.total }}</h3>
                        </div>
                        <span class="hero-pill">{{ t('sections.payments') }}</span>
                    </div>
                    <div class="hero-card">
                        <div>
                            <div class="muted small">{{ t('dashboard.feedbackTitle') }}</div>
                            <h3>{{ dashboardNotes.length }}</h3>
                        </div>
                        <span class="hero-pill">{{ t('dashboard.feedbackTitle') }}</span>
                    </div>
                </div>
                <div class="dashboard-grid">
                    <div class="card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('dashboard.feedbackTitle') }}</h2>
                            <span class="muted small">{{ t('dashboard.feedbackSubtitle') }}</span>
                        </div>
                        <button class="small" type="button" @click="loadDashboardNotes" :disabled="dashboardNotesLoading">{{ t('actions.refresh') }}</button>
                    </div>
                    <div v-if="dashboardNotesLoading" class="muted small">{{ t('dashboard.loadingFeedback') }}</div>
                    <div v-else-if="dashboardNotesError" class="muted small">{{ dashboardNotesError }}</div>
                    <div v-else-if="dashboardNotes.length===0" class="muted small">{{ t('dashboard.noFeedback') }}</div>
                    <div v-else class="chat-list">
                        <div v-for="note in dashboardNotes" :key="note.id" class="chat-item">
                            <div class="chat-meta">
                                <strong>{{ note.traineeName }}</strong>
                                <div class="chat-meta-actions">
                                    <span class="pill">{{ note.statusLabel }}</span>
                                    <button class="icon-button" type="button" @click="closeDashboardNote(note)" :disabled="dashboardNoteClosing[note.id]" :aria-label="t('actions.closeFeedback')" :title="t('actions.closeFeedback')">×</button>
                                </div>
                            </div>
                            <div class="muted small" v-if="note.dateLabel">{{ note.dateLabel }}</div>
                            <div class="chat-message">{{ note.message }}</div>
                        </div>
                    </div>
                </div>

                    <div class="card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('dashboard.generalTitle') }}</h2>
                            <span class="muted small">{{ t('dashboard.generalSubtitle') }}</span>
                        </div>
                        <span class="pill">{{ t('labels.shownCount', { count: dashboardTrainees.length }) }}</span>
                    </div>
                    <div v-if="dashboardTrainees.length===0" class="muted small" style="margin-top:10px">
                        {{ t('dashboard.generalEmpty') }}
                    </div>
                    <div v-else class="dashboard-trainee-list scroll-area">
                        <div class="dashboard-trainee-item" v-for="u in dashboardTrainees" :key="u.id">
                            <div class="stack">
                                <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                <span class="muted small mono">{{ u.id }}</span>
                            </div>
                            <div class="stack dashboard-trainee-actions">
                                <span class="pill" :class="u.paid ? 'paid' : 'overdue'">
                                    {{ u.paid ? t('payment.onTime') : t('payment.overdue') }}
                                </span>
                                <button class="small" type="button" @click="openTrainee(u)">{{ t('actions.openTrainee') }}</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="showLastWeekCard" class="card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('dashboard.lastWeekTitle') }}</h2>
                            <span class="muted small">{{ t('dashboard.lastWeekSubtitle') }}</span>
                        </div>
                        <span class="pill">{{ t('labels.shownCount', { count: lastWeekTrainees.length }) }}</span>
                    </div>
                    <div v-if="loadingWeekStatus" class="muted small" style="margin-top:10px">
                        {{ t('dashboard.lastWeekLoading') }}
                    </div>
                    <div v-else-if="weekStatusError" class="muted small" style="margin-top:10px">
                        {{ weekStatusError }}
                    </div>
                    <div v-else-if="lastWeekTrainees.length===0" class="muted small" style="margin-top:10px">
                        {{ t('dashboard.lastWeekEmpty') }}
                    </div>
                    <div v-else class="dashboard-trainee-list scroll-area">
                        <div class="dashboard-trainee-item" v-for="u in lastWeekTrainees" :key="u.id">
                            <div class="stack">
                                <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                <span class="muted small">{{ weekStatusFor(u) }}</span>
                            </div>
                            <div class="stack dashboard-trainee-actions">
                                <span class="pill warning">{{ t('labels.lastWeek') }}</span>
                                <button class="small" type="button" @click="openTrainee(u)">{{ t('actions.openTrainee') }}</button>
                            </div>
                        </div>
                    </div>
                </div>

                    <div class="card dashboard-burndown-card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('dashboard.burndownTitle') }}</h2>
                            <span class="muted small">{{ t('dashboard.burndownSubtitle') }}</span>
                        </div>
                        <span class="pill" v-if="dashboardBurndown.minDateLabel && dashboardBurndown.maxDateLabel">
                            {{ dashboardBurndown.minDateLabel }} → {{ dashboardBurndown.maxDateLabel }}
                        </span>
                    </div>
                    <div v-if="dashboardBurndownLoading" class="muted small" style="margin-top:10px">
                        {{ t('dashboard.burndownLoading') }}
                    </div>
                    <div v-else-if="dashboardBurndownError" class="muted small" style="margin-top:10px">
                        {{ dashboardBurndownError }}
                    </div>
                    <div v-else-if="dashboardBurndown.lines.length===0" class="muted small" style="margin-top:10px">
                        {{ t('dashboard.burndownEmpty') }}
                    </div>
                    <div v-else class="burndown-chart-wrap">
                        <svg
                            class="burndown-chart"
                            role="img"
                            aria-hidden="true"
                            :viewBox="`0 0 ${dashboardBurndown.chartWidth} ${dashboardBurndown.chartHeight}`"
                        >
                            <polyline
                                v-for="line in visibleBurndownLines"
                                :key="line.traineeId"
                                :points="line.polyline"
                                :stroke="line.color"
                                stroke-width="2"
                                fill="none"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            />
                        </svg>
                        <div class="burndown-axis-label burndown-axis-label-y">
                            {{ t('dashboard.burndownYAxis') }}
                        </div>
                        <div class="burndown-axis-label burndown-axis-label-x">
                            {{ t('dashboard.burndownXAxis') }}
                        </div>
                        <div class="burndown-legend">
                            <button
                                class="burndown-legend-item"
                                :class="{ active: isBurndownTraineeSelected(line.traineeId) }"
                                v-for="line in dashboardBurndown.lines"
                                :key="line.traineeId"
                                type="button"
                                @click="toggleBurndownTraineeSelection(line.traineeId)"
                            >
                                <span class="burndown-legend-swatch" :style="{ backgroundColor: line.color }"></span>
                                <div>
                                    <strong>{{ line.traineeName }}</strong>
                                    <div class="muted small">
                                        {{ t('dashboard.burndownRemaining', { remaining: line.latestRemaining, total: line.total }) }}
                                    </div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                </div>
            </div>

            <div class="row section-panel" :class="{active: activeSection==='trainees'}">
                <div class="col">
                    <div class="card">
                    <h2 style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                        {{ t('sections.trainees') }}
                        <span class="pill">{{ t('labels.shownCount', { count: filteredUsers.length }) }}</span>
                    </h2>
                    <div class="muted small" v-if="loadingProgress">{{ t('status.refreshingProgress') }}</div>
                    <div class="list scroll-area">
                        <div v-for="u in filteredUsers" :key="u.id" class="card" style="padding:12px">
                            <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                                <div>
                                    <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                    <div class="muted small mono">{{ u.id }}</div>
                                </div>
                                <span class="badge">{{ t('trainees.badge') }}</span>
                            </div>
                            <div class="progress-row" v-if="progressFor(u).total">
                                <div class="progress-bar">
                                    <span :style="{ width: progressFor(u).percent + '%' }"></span>
                                </div>
                                <div class="progress-meta small">
                                    <span>{{ progressFor(u).percent }}%</span>
                                    <span class="muted">{{ progressFor(u).completed }}/{{ progressFor(u).total }}</span>
                                </div>
                            </div>
                            <div class="muted small" v-else>{{ t('status.noProgress') }}</div>
                            <div class="trainer-row">
                                <span class="muted small">{{ t('trainers.assigned') }}</span>
                                <div class="trainer-tags">
                                    <span v-if="!u.trainers || u.trainers.length===0" class="muted small">
                                        {{ t('trainers.none') }}
                                    </span>
                                    <span v-else v-for="trainer in u.trainers" :key="trainer.id" class="pill trainer-pill">
                                        {{ trainer.name }}
                                        <button
                                            v-if="canAssignTrainers"
                                            class="icon-button"
                                            type="button"
                                            @click="removeTrainerAssignment(u, trainer)"
                                            :aria-label="t('actions.delete')"
                                        >
                                            ×
                                        </button>
                                    </span>
                                </div>
                            </div>
                            <div v-if="canAssignTrainers" class="trainer-assign">
                                <select v-model="trainerSelections[u.id]">
                                    <option value="">{{ t('trainers.select') }}</option>
                                    <option
                                        v-for="trainer in trainers"
                                        :key="trainer.id"
                                        :value="trainer.id"
                                        :disabled="u.trainerIds && u.trainerIds.includes(trainer.id)"
                                    >
                                        {{ trainer.name }}
                                    </option>
                                </select>
                                <button
                                    class="small"
                                    type="button"
                                    :disabled="trainerAssignmentSaving[u.id] || !trainerSelections[u.id]"
                                    @click="assignTrainerToTrainee(u)"
                                >
                                    {{ t('actions.assignTrainer') }}
                                </button>
                            </div>
                            <div class="payment-row">
                                <span class="pill" :class="u.paid ? 'paid' : 'overdue'">
                                    {{ u.paid ? t('payment.onTime') : t('payment.overdue') }}
                                </span>
                                <label class="payment-toggle small">
                                    <input
                                        type="checkbox"
                                        :checked="u.paid"
                                        :disabled="paymentSaving[u.id]"
                                        @change="togglePayment(u, $event)"
                                    />
                                    <span>{{ t('payment.toggle') }}</span>
                                </label>
                            </div>
                            <div class="muted small" v-if="paymentSaving[u.id]">{{ t('status.updatingPayment') }}</div>
                            <div class="muted small" v-if="trainerAssignmentSaving[u.id]">{{ t('status.updatingTrainer') }}</div>
                            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
                                <button class="btn" @click="openTrainee(u)">{{ t('actions.openTrainee') }}</button>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>

            <div class="section-panel payments-panel" :class="{active: activeSection==='payments'}">
                <div class="dashboard-grid payments-grid">
                    <div class="card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('payments.overviewTitle') }}</h2>
                            <span class="muted small">{{ t('payments.overviewSubtitle') }}</span>
                        </div>
                        <span class="pill">{{ t('labels.shownCount', { count: paymentUsers.length }) }}</span>
                    </div>
                    <div class="filter-row">
                        <button
                                v-for="filter in paymentFilterOptions"
                                :key="filter.value"
                                type="button"
                                :class="{active: paymentFilter===filter.value}"
                                @click="paymentFilter=filter.value"
                        >
                            {{ t(filter.labelKey) }}
                        </button>
                    </div>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span class="summary-label">{{ t('payments.totalLabel') }}</span>
                            <strong>{{ paymentSummary.total }}</strong>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">{{ t('payments.paidLabel') }}</span>
                            <strong>{{ paymentSummary.paid }}</strong>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">{{ t('payments.overdueLabel') }}</span>
                            <strong>{{ paymentSummary.overdue }}</strong>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">{{ t('payments.receivedAmountLabel') }}</span>
                            <strong>{{ formatAmount(paymentSummary.receivedAmount) }}</strong>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">{{ t('payments.forecastedAmountLabel') }}</span>
                            <strong>{{ formatAmount(paymentSummary.forecastedAmount) }}</strong>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">{{ t('payments.dueAmountLabel') }}</span>
                            <strong>{{ formatAmount(paymentSummary.dueAmount) }}</strong>
                        </div>
                    </div>
                </div>

                    <div class="card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('payments.overdueTitle') }}</h2>
                            <span class="muted small">{{ t('payments.overdueSubtitle') }}</span>
                        </div>
                    </div>
                    <div v-if="overdueUsers.length===0" class="muted small">{{ t('payments.noOverdue') }}</div>
                    <div v-else class="list">
                        <div v-for="u in overdueUsers" :key="u.id" class="payment-alert">
                            <div class="stack">
                                <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                <span class="muted small mono">{{ u.id }}</span>
                            </div>
                            <div class="inline-actions">
                                <button class="small" type="button" :disabled="paymentSaving[u.id]" @click="markPaymentPaid(u)">
                                    {{ t('payments.markPaid') }}
                                </button>
                                <button class="small" type="button" @click="openTrainee(u)">{{ t('dashboard.openProgram') }}</button>
                            </div>
                        </div>
                    </div>
                </div>

                    <div class="card payments-manage-card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('payments.manageTitle') }}</h2>
                            <span class="muted small">{{ t('payments.manageSubtitle') }}</span>
                        </div>
                    </div>
                    <div v-if="paymentUsers.length===0" class="muted small">{{ t('payments.noMatches') }}</div>
                    <div v-else class="list scroll-area payments-list">
                        <div v-for="u in paymentUsers" :key="u.id" class="card payment-card">
                            <div class="payment-card-header">
                                <div class="stack">
                                    <strong>{{ u.displayName || shortId(u.id) }}</strong>
                                </div>
                            </div>
                            <div class="payment-actions">
                                <span class="pill" :class="u.paid ? 'paid' : 'overdue'">
                                    {{ u.paid ? t('payment.onTime') : t('payment.overdue') }}
                                </span>
                                <button class="small" type="button" @click="openTrainee(u)">{{ t('actions.openTrainee') }}</button>
                            </div>
                            <div class="payment-amount-row">
                                <label class="stack small">
                                    <span class="muted small">{{ t('labels.amount') }}</span>
                                    <input
                                        type="number"
                                        min="0"
                                        step="0.01"
                                        v-model="paymentAmountEdits[u.id]"
                                        :placeholder="t('placeholders.amount')"
                                    />
                                </label>
                                <button
                                    class="small"
                                    type="button"
                                    :disabled="paymentAmountSaving[u.id]"
                                    @click="savePaymentAmount(u)"
                                >
                                    {{ t('actions.save') }}
                                </button>
                            </div>
                            <div class="muted small" v-if="paymentSaving[u.id]">{{ t('status.updatingPayment') }}</div>
                            <div class="muted small" v-if="paymentAmountSaving[u.id]">{{ t('status.updatingPaymentAmount') }}</div>
                        </div>
                    </div>
                </div>

                    <div class="card payment-trend-card">
                    <div class="dashboard-card-header">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('payments.trendTitle') }}</h2>
                            <span class="muted small">{{ t('payments.trendSubtitle') }}</span>
                        </div>
                    </div>
                    <div v-if="paymentTrendsLoading" class="muted small">
                        {{ t('status.loadingPaymentTrends') }}
                    </div>
                    <div v-else-if="paymentTrendsError" class="muted small">{{ paymentTrendsError }}</div>
                    <div v-else-if="paymentTrends.series.length===0" class="muted small">
                        {{ t('payments.trendEmpty') }}
                    </div>
                    <div v-else class="payment-trend-body">
                        <svg
                            class="payment-trend-chart"
                            role="img"
                            :aria-label="t('payments.trendTitle')"
                            :viewBox="`0 0 ${paymentTrends.chartWidth} ${paymentTrends.chartHeight}`"
                        >
                            <g class="payment-trend-axis-ticks">
                                <text
                                    v-for="(tick, index) in paymentTrends.axisTicks"
                                    :key="index"
                                    class="payment-trend-axis-label"
                                    x="6"
                                    :y="tick.y + 4"
                                >
                                    {{ tick.label }}
                                </text>
                            </g>
                            <line
                                class="payment-trend-axis-line"
                                x1="24"
                                :x2="paymentTrends.chartWidth - 24"
                                :y1="paymentTrends.chartHeight - 28"
                                :y2="paymentTrends.chartHeight - 28"
                            ></line>
                            <polyline
                                v-for="line in paymentTrends.series"
                                :key="line.key"
                                class="payment-trend-line"
                                :stroke="line.color"
                                :points="line.polyline"
                            ></polyline>
                        </svg>
                        <div v-if="paymentTrends.months.length" class="payment-trend-axis">
                            <span>{{ formatMonthLabel(paymentTrends.months[0]) }}</span>
                            <span>{{ formatMonthLabel(paymentTrends.months[paymentTrends.months.length - 1]) }}</span>
                        </div>
                        <div class="payment-trend-legend">
                            <div v-for="line in paymentTrends.series" :key="line.key" class="legend-item">
                                <span class="legend-swatch" :style="{ backgroundColor: line.color }"></span>
                                <span>{{ t(line.labelKey) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>

            <div class="row section-panel program-panel" :class="{active: activeSection==='program'}">
                <div class="col program-main">
                    <div class="card" v-if="!current">
                    <h2>{{ t('program.title') }}</h2>
                    <p class="muted">{{ t('program.empty') }}</p>
                </div>

                    <template v-else>
                        <div class="card">
                        <div class="stack">
                            <h2 style="margin:0">{{ t('program.titleWithName', { name: current.displayName || shortId(current.id) }) }}</h2>
                            <p class="muted">{{ t('program.subtitle') }}</p>
                        </div>
                    </div>

                    <div class="overview-grid">
                        <div class="card">
                            <div class="overview-card-header">
                                <div class="stack">
                                    <h3 style="margin:0">{{ t('program.calendarTitle') }}</h3>
                                    <span class="muted small">{{ t('program.calendarSubtitle') }}</span>
                                </div>
                                <button class="small" type="button" @click="loadDays">{{ t('actions.refresh') }}</button>
                            </div>
                            <div v-if="trainingCalendar.length===0" class="muted small">{{ t('program.calendarEmpty') }}</div>
                            <div v-else class="calendar-grid">
                                <div v-for="entry in trainingCalendar" :key="entry.id" class="calendar-item" :class="{trained: entry.trained}">
                                    <div class="stack">
                                        <strong>{{ entry.label }}</strong>
                                        <span v-if="entry.total" class="muted small">{{ t('program.calendarExercises', { completed: entry.completed, total: entry.total }) }}</span>
                                        <span v-else class="muted small">{{ t('program.calendarNoExercises') }}</span>
                                    </div>
                                    <span class="tag" :class="{accent: entry.trained}">
                                        {{ entry.trained ? t('program.calendarTrained') : t('program.calendarNoTraining') }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="overview-card-header">
                                <div class="stack">
                                    <h3 style="margin:0">{{ t('program.dataTitle') }}</h3>
                                    <span class="muted small">{{ t('program.dataSubtitle') }}</span>
                                </div>
                                <button class="small" type="button" @click="openTrainee(current)">{{ t('actions.refresh') }}</button>
                            </div>
                            <div class="data-list">
                                <div class="data-row">
                                    <span class="muted small">{{ t('labels.name') }}</span>
                                    <strong>{{ current.displayName || shortId(current.id) }}</strong>
                                </div>
                                <div class="data-row">
                                    <span class="muted small">{{ t('labels.id') }}</span>
                                    <span class="mono">{{ current.id }}</span>
                                </div>
                                <div class="data-row">
                                    <span class="muted small">{{ t('trainers.assigned') }}</span>
                                    <div class="data-chips" v-if="current.trainers && current.trainers.length">
                                        <span v-for="trainer in current.trainers" :key="trainer.id" class="pill">{{ trainer.name }}</span>
                                    </div>
                                    <span v-else class="muted small">{{ t('trainers.none') }}</span>
                                </div>
                                <div class="data-row">
                                    <span class="muted small">{{ t('program.paymentStatus') }}</span>
                                    <span class="pill" :class="current.paid ? 'paid' : 'overdue'">
                                        {{ current.paid ? t('payment.onTime') : t('payment.overdue') }}
                                    </span>
                                </div>
                                <div class="data-row">
                                    <span class="muted small">{{ t('program.progressLabel') }}</span>
                                    <span>
                                        {{ progressFor(current).percent }}% ({{ progressFor(current).completed }}/{{ progressFor(current).total }})
                                    </span>
                                </div>
                            </div>
                            <div class="data-block">
                                <span class="muted small">{{ t('program.maxTestsTitle') }}</span>
                                <div v-if="loadingMaxTests" class="muted small">{{ t('status.loadingMaxTests') }}</div>
                                <div v-else-if="maxTestsError" class="muted small">{{ maxTestsError }}</div>
                                <div v-else-if="maxTestHistory.length===0" class="muted small">{{ t('history.none') }}</div>
                                <div v-else class="data-chips">
                                    <span v-for="item in maxTestHistory" :key="item.exercise" class="pill">
                                        {{ item.exercise }} • {{ formatTestValue(item.bestValue) }} {{ item.unit }}
                                    </span>
                                </div>
                            </div>
                            <div class="data-block">
                                <span class="muted small">{{ t('program.coachTipTitle') }}</span>
                                <textarea
                                    v-model="coachTipDraft"
                                    :placeholder="t('program.coachTipPlaceholder')"
                                    :disabled="coachTipSaving"
                                ></textarea>
                                <div style="display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap">
                                    <button class="small" type="button" @click="saveCoachTip" :disabled="coachTipSaving">
                                        {{ t('actions.save') }}
                                    </button>
                                </div>
                                <div class="muted small" v-if="coachTipSaving">{{ t('status.savingCoachTip') }}</div>
                            </div>
                            <div class="data-block" v-if="currentTrainer">
                                <span class="muted small">{{ t('program.trainerNotesTitle') }}</span>
                                <textarea
                                    v-model="trainerNotesDraft"
                                    :placeholder="t('program.trainerNotesPlaceholder')"
                                    :disabled="trainerNotesSaving"
                                ></textarea>
                                <div style="display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap">
                                    <button class="small" type="button" @click="saveTrainerNotes" :disabled="trainerNotesSaving">
                                        {{ t('actions.save') }}
                                    </button>
                                </div>
                                <div class="muted small" v-if="trainerNotesSaving">{{ t('status.savingTrainerNotes') }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="overview-grid">
                        <div class="card">
                            <div class="overview-card-header">
                                <div class="stack">
                                    <h3 style="margin:0">
                                        {{ current ? t('history.titleWithName', { name: current.displayName || shortId(current.id) }) : t('history.title') }}
                                    </h3>
                                    <span class="muted small">{{ t('history.subtitle') }}</span>
                                </div>
                                <button class="small" type="button" @click="loadMaxTests">{{ t('actions.refresh') }}</button>
                            </div>
                            <div v-if="loadingMaxTests" class="muted small">{{ t('status.loadingMaxTests') }}</div>
                            <div v-else-if="maxTestsError" class="muted small">{{ maxTestsError }}</div>
                            <div v-else-if="maxTestHistory.length===0" class="muted small">{{ t('history.none') }}</div>
                            <div v-else class="history-grid">
                                <div v-for="item in maxTestHistory" :key="item.exercise" class="card history-card">
                                    <div class="history-card-head">
                                        <div class="stack">
                                            <strong>{{ item.exercise }}</strong>
                                            <span class="muted small">
                                                {{ t('history.testsBest', { countLabel: formatCount(item.count, 'labels.testCount', 'labels.testsCount'), value: formatTestValue(item.bestValue), unit: item.unit }) }}
                                            </span>
                                        </div>
                                        <span class="muted small" v-if="item.latestLabel">{{ item.latestLabel }}</span>
                                    </div>
                                    <div class="history-chart-wrap">
                                        <div class="history-y-axis small muted">
                                            <span>{{ formatTestValue(item.maxValue) }}</span>
                                            <span>{{ formatTestValue(item.minValue) }}</span>
                                        </div>
                                        <svg
                                            class="history-chart"
                                            :viewBox="`0 0 ${item.chartWidth} ${item.chartHeight}`"
                                            role="img"
                                            :aria-label="t('history.chartAria', { exercise: item.exercise })"
                                        >
                                            <polyline class="history-line" :points="item.polyline"></polyline>
                                            <circle
                                                v-for="(point, idx) in item.points"
                                                :key="`${item.exercise}-${idx}`"
                                                class="history-point"
                                                :class="{latest: idx === item.points.length - 1}"
                                                :cx="point.x"
                                                :cy="point.y"
                                            ></circle>
                                        </svg>
                                    </div>
                                    <div class="history-meta small">
                                        <span>{{ item.minDateLabel }}</span>
                                        <span>{{ item.maxDateLabel }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="overview-card-header">
                                <div class="stack">
                                    <h3 style="margin:0">{{ t('program.completedLogTitle') }}</h3>
                                    <span class="muted small">{{ t('program.completedLogSubtitle') }}</span>
                                </div>
                                <button class="small" type="button" @click="loadCompletedExercises">{{ t('actions.refresh') }}</button>
                            </div>
                            <div v-if="loadingCompletedExercises" class="muted small">{{ t('status.loadingCompletedExercises') }}</div>
                            <div v-else-if="completedExercisesError" class="muted small">{{ completedExercisesError }}</div>
                            <div v-else-if="completedExerciseLog.length===0" class="muted small">{{ t('program.completedLogEmpty') }}</div>
                            <div v-else class="list">
                                <div v-for="item in completedExerciseLog" :key="item.id" class="exercise-log-item">
                                    <div class="stack">
                                        <strong>{{ item.exercise }}</strong>
                                        <span class="muted small">{{ item.dayLabel }}</span>
                                        <span class="muted small" v-if="item.timeLabel">{{ item.timeLabel }}</span>
                                        <span class="muted small" v-if="item.notes">{{ t('labels.notes') }}: {{ item.notes }}</span>
                                        <span class="muted small" v-if="item.traineeNotes">{{ t('labels.traineeNotes') }}: {{ item.traineeNotes }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overview-grid">
                        <div class="card plan-manager-card">
                            <div class="overview-card-header">
                                <div class="stack">
                                    <h3 style="margin:0">{{ t('program.plansTitle') }}</h3>
                                    <span class="muted small">{{ t('program.plansSubtitle') }}</span>
                                </div>
                                <button class="small" type="button" @click="loadPlans">{{ t('actions.refresh') }}</button>
                            </div>
                            <div class="plan-manager">
                                <div class="plan-form">
                                    <h4 style="margin:0">{{ t('plans.addTitle') }}</h4>
                                    <div class="plan-form-row">
                                        <label class="stack small">
                                            <span class="muted small">{{ t('labels.planName') }}</span>
                                            <input v-model="newPlanName" :placeholder="t('program.planExample')" />
                                        </label>
                                        <label class="stack small">
                                            <span class="muted small">{{ t('labels.status') }}</span>
                                            <select v-model="newPlanStatus">
                                                <option v-for="status in planStatuses" :key="status" :value="status">
                                                    {{ planStatusLabel(status) }}
                                                </option>
                                            </select>
                                        </label>
                                        <label class="stack small">
                                            <span class="muted small">{{ t('labels.startsAt') }}</span>
                                            <input type="date" v-model="newPlanStartsAt" />
                                        </label>
                                    </div>
                                    <label class="stack small">
                                        <span class="muted small">{{ t('labels.notes') }}</span>
                                        <textarea v-model="newPlanNotes" :placeholder="t('program.planNotes')"></textarea>
                                    </label>
                                    <div class="plan-form-actions">
                                        <button class="small" type="button" @click="addPlan" :disabled="savingPlan">
                                            {{ t('actions.add') }}
                                        </button>
                                        <button class="small" type="button" @click="resetPlanForm" :disabled="savingPlan">
                                            {{ t('actions.clear') }}
                                        </button>
                                        <span v-if="savingPlan" class="muted small">{{ t('status.savingPlan') }}</span>
                                    </div>
                                </div>
                                <div class="plan-list">
                                    <h4 style="margin:0">{{ t('plans.listTitle') }}</h4>
                                    <div v-if="plans.length===0" class="muted small">{{ t('plans.none') }}</div>
                                    <div v-else class="plan-edit-list">
                                        <div v-for="plan in plans" :key="plan.id" class="plan-item plan-edit-card">
                                            <div class="stack">
                                                <strong>{{ plan.title }}</strong>
                                                <span class="muted small">{{ planStatusLabel(plan.status) }}</span>
                                                <span class="muted small" v-if="plan.created_at">
                                                    {{ t('labels.createdAt') }}: {{ formatDate(plan.created_at) }}
                                                </span>
                                                <span class="muted small" v-if="plan.starts_on">
                                                    {{ t('labels.startsAt') }}: {{ formatDate(plan.starts_on) }}
                                                </span>
                                            </div>
                                            <div v-if="planEdits[plan.id]" class="plan-edit-form">
                                                <label class="stack small">
                                                    <span class="muted small">{{ t('labels.planName') }}</span>
                                                    <input v-model="planEdits[plan.id].name" />
                                                </label>
                                                <label class="stack small">
                                                    <span class="muted small">{{ t('labels.status') }}</span>
                                                    <select v-model="planEdits[plan.id].status">
                                                        <option v-for="status in planStatuses" :key="status" :value="status">
                                                            {{ planStatusLabel(status) }}
                                                        </option>
                                                    </select>
                                                </label>
                                                <label class="stack small">
                                                    <span class="muted small">{{ t('labels.startsAt') }}</span>
                                                    <input type="date" v-model="planEdits[plan.id].starts_on" />
                                                </label>
                                                <label class="stack small plan-edit-notes">
                                                    <span class="muted small">{{ t('labels.notes') }}</span>
                                                    <textarea v-model="planEdits[plan.id].notes"></textarea>
                                                </label>
                                            </div>
                                            <div class="plan-form-actions">
                                                <button class="small" type="button" @click="savePlan(plan)" :disabled="savingPlan">
                                                    {{ t('actions.save') }}
                                                </button>
                                                <button class="small" type="button" @click="resetPlanEdit(plan)" :disabled="savingPlan">
                                                    {{ t('actions.reset') }}
                                                </button>
                                                <button class="small danger" type="button" @click="deletePlan(plan)" :disabled="savingPlan">
                                                    {{ t('actions.delete') }}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="overview-card-header">
                                <div class="stack">
                                    <h3 style="margin:0">{{ t('program.paymentsTitle') }}</h3>
                                    <span class="muted small">{{ t('program.paymentsSubtitle') }}</span>
                                </div>
                                <button class="small" type="button" @click="loadPaymentHistory">{{ t('actions.refresh') }}</button>
                            </div>
                            <div v-if="loadingPayments" class="muted small">{{ t('status.loadingPayments') }}</div>
                            <div v-else-if="paymentsError" class="muted small">{{ paymentsError }}</div>
                            <div v-else-if="paymentHistory.length===0" class="muted small">{{ t('program.paymentsEmpty') }}</div>
                            <div v-else class="list">
                                <div v-for="payment in paymentHistory" :key="payment.id" class="payment-history-item">
                                    <div class="stack">
                                        <strong>{{ formatDate(payment.month_start) }}</strong>
                                        <span class="muted small" v-if="payment.paid_at">{{ t('program.paidAt', { date: formatDate(payment.paid_at) }) }}</span>
                                        <span
                                            class="muted small"
                                            v-if="payment.amount !== null && payment.amount !== undefined"
                                        >
                                            {{ t('payment.amountLabel', { amount: formatAmount(payment.amount) }) }}
                                        </span>
                                    </div>
                                    <span class="pill" :class="payment.paid ? 'paid' : 'overdue'">
                                        {{ payment.paid ? t('payment.onTime') : t('payment.overdue') }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="overview-grid">
                        <div class="card">
                            <div class="workout-editor-header">
                                <div class="stack">
                                    <h3 class="workout-editor-title">{{ t('program.planBuilderTitle') }}</h3>
                                    <span class="muted small">{{ t('program.planBuilderSubtitle') }}</span>
                                </div>
                                <div class="workout-editor-header-actions">
                                    <button
                                        class="btn workout-editor-create"
                                        type="button"
                                        @click="saveTemplatePlan"
                                        :disabled="savingTemplatePlan"
                                    >
                                        <span class="workout-editor-create-icon">+</span>
                                        {{ selectedTemplatePlanId ? t('actions.save') : t('actions.createWorkout') }}
                                    </button>
                                    <span v-if="savingTemplatePlan" class="muted small">{{ t('status.savingPlan') }}</span>
                                    <span v-if="templatePlanLoading" class="muted small">{{ t('status.loadingPlan') }}</span>
                                </div>
                            </div>
                            <div class="workout-editor-settings">
                                <label class="stack small">
                                    <span class="muted small">{{ t('labels.plan') }}</span>
                                    <select v-model="selectedTemplatePlanId" :disabled="templatePlanLoading">
                                        <option value="">{{ t('placeholders.newPlan') }}</option>
                                        <option v-for="plan in plans" :key="plan.id" :value="plan.id">
                                            {{ plan.title || t('labels.untitled') }}
                                        </option>
                                    </select>
                                </label>
                                <label class="stack small">
                                    <span class="muted small">{{ t('labels.planName') }}</span>
                                    <input v-model="templatePlanName" :placeholder="t('program.planExample')" />
                                </label>
                                <label class="stack small">
                                    <span class="muted small">{{ t('labels.days') }}</span>
                                    <select v-model.number="templateDayCount">
                                        <option v-for="option in templateDayOptions" :key="option" :value="option">
                                            {{ option }}
                                        </option>
                                    </select>
                                </label>
                                <label class="stack small">
                                    <span class="muted small">{{ t('labels.weeks') }}</span>
                                    <select v-model.number="templateWeekCount">
                                        <option v-for="option in templateWeekOptions" :key="option" :value="option">
                                            {{ option }}
                                        </option>
                                    </select>
                                </label>
                                <label class="stack small">
                                    <span class="muted small">{{ t('labels.exercises') }}</span>
                                    <select v-model.number="templateSlotCount">
                                        <option v-for="option in templateExerciseOptions" :key="option" :value="option">
                                            {{ option }}
                                        </option>
                                    </select>
                                </label>
                            </div>
                            <div class="workout-editor-grid">
                                <div class="workout-editor-column">
                                    <div class="workout-hero-card">
                                        <div class="workout-hero-overlay">
                                            <span class="workout-hero-tag">{{ t('program.planBuilderTitle') }}</span>
                                        </div>
                                    </div>
                                    <div class="workout-card">
                                        <div class="workout-card-header">
                                            <h4>{{ t('labels.days') }}</h4>
                                            <button
                                                class="icon-button"
                                                type="button"
                                                @click="incrementTemplateDayCount"
                                                :disabled="templateDayCount >= templateDayOptions[templateDayOptions.length - 1]"
                                            >
                                                +
                                            </button>
                                        </div>
                                        <div class="workout-days">
                                            <div
                                                v-for="group in templateWeekGroups"
                                                :key="`week-${group.week}`"
                                                class="workout-week-group"
                                            >
                                                <div class="workout-week-header">
                                                    {{ t('labels.weekNumber', { week: group.week }) }}
                                                </div>
                                                <button
                                                    v-for="entry in group.days"
                                                    :key="entry.day.id"
                                                    class="workout-day-item"
                                                    :class="{ active: entry.index === selectedTemplateDay }"
                                                    type="button"
                                                    @click="selectTemplateDay(entry.index)"
                                                >
                                                    <div class="stack">
                                                        <strong>{{ templateDayLabel(entry.index) }}</strong>
                                                        <span class="muted small">
                                                            {{ entry.day.title || t('placeholders.workoutTitle') }}
                                                        </span>
                                                    </div>
                                                </button>
                                            </div>
                                        </div>
                                        <label class="stack small workout-day-title">
                                            <span class="muted small">{{ t('labels.title') }}</span>
                                            <input v-model="activeTemplateDay.title" :placeholder="t('placeholders.workoutTitle')" />
                                        </label>
                                    </div>
                                </div>
                                <div class="workout-editor-column">
                                    <div class="workout-card">
                                        <div class="workout-card-header">
                                            <h4>{{ t('labels.activities') }}</h4>
                                            <button
                                                class="icon-button"
                                                type="button"
                                                @click="incrementTemplateSlotCount"
                                                :disabled="templateSlotCount >= templateExerciseOptions[templateExerciseOptions.length - 1]"
                                            >
                                                +
                                            </button>
                                        </div>
                                        <div class="workout-activity-list">
                                            <button
                                                v-for="(slot, slotIndex) in activeTemplateSlots"
                                                :key="`${activeTemplateDay.id}-${slotIndex}`"
                                                class="workout-activity-item"
                                                :class="{ active: slotIndex === selectedTemplateSlot }"
                                                type="button"
                                                @click="selectTemplateSlot(slotIndex)"
                                            >
                                                <div class="stack">
                                                    <strong>{{ resolveTemplateSlotName(slot) || t('placeholders.exerciseName') }}</strong>
                                                </div>
                                                <span class="workout-activity-check" :class="{ active: slotIndex === selectedTemplateSlot }">
                                                    ✓
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="workout-editor-column">
                                    <div class="workout-card workout-detail-card">
                                        <div class="workout-card-header">
                                            <h4>{{ resolveTemplateSlotName(activeTemplateSlot) || t('labels.exercise') }}</h4>
                                        </div>
                                        <div class="workout-detail-image">
                                            <span class="muted small">{{ t('labels.preview') }}</span>
                                        </div>
                                        <div class="workout-detail-grid">
                                            <label class="stack small">
                                                <span class="muted small">{{ t('labels.exercise') }}</span>
                                                <select v-model="activeTemplateSlot.exercise_id">
                                                    <option value="">
                                                        {{ t('placeholders.exerciseName') }}
                                                    </option>
                                                    <option
                                                        v-for="exercise in exercises"
                                                        :key="exercise.id"
                                                        :value="exercise.id"
                                                    >
                                                        {{ exercise.name || exercise.slug || exercise.id }}
                                                    </option>
                                                </select>
                                            </label>
                                        </div>
                                        <label class="stack small">
                                            <span class="muted small">{{ t('labels.notes') }}</span>
                                            <textarea
                                                v-model="activeTemplateSlot.notes"
                                                :placeholder="t('placeholders.notesOptional')"
                                            ></textarea>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </template>
                </div>

            </div>

            <div class="section-panel exercises-panel" :class="{active: activeSection==='exercises'}">
                <div class="overview-grid">
                    <div class="card">
                        <div class="overview-card-header">
                            <div class="stack">
                                <h3>{{ t('sections.exercises') }}</h3>
                                <span class="muted small">{{ t('exercises.available') }}</span>
                            </div>
                        </div>
                        <div class="exercise-form-grid">
                            <label class="stack small">
                                <span class="muted small">{{ t('labels.name') }}</span>
                                <input v-model="exerciseForm.name" :placeholder="t('placeholders.exerciseName')" />
                            </label>
                            <label class="stack small">
                                <span class="muted small">{{ t('labels.slug') }}</span>
                                <input v-model="exerciseForm.slug" :placeholder="t('placeholders.slugExample')" />
                            </label>
                            <label class="stack small">
                                <span class="muted small">{{ t('labels.difficulty') }}</span>
                                <select v-model="exerciseForm.difficulty">
                                    <option v-for="option in exerciseDifficultyOptions" :key="option" :value="option">
                                        {{ formatDifficultyLabel(option) }}
                                    </option>
                                </select>
                            </label>
                            <label class="stack small">
                                <span class="muted small">{{ t('labels.sortOrder') }}</span>
                                <input v-model.number="exerciseForm.sort_order" type="number" min="1" />
                            </label>
                        </div>
                        <div class="exercise-form-actions">
                            <button class="btn primary" type="button" @click="createExercise" :disabled="creatingExercise">
                                {{ t('actions.add') }}
                            </button>
                            <button class="btn ghost" type="button" @click="resetExerciseForm" :disabled="creatingExercise">
                                {{ t('actions.reset') }}
                            </button>
                            <span v-if="creatingExercise" class="muted small">{{ t('status.savingExercise') }}</span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="overview-card-header">
                            <div class="stack">
                                <h3>{{ t('exercises.available') }}</h3>
                                <span class="muted small">{{ t('labels.exercisesCount', { count: filteredExercises.length }) }}</span>
                            </div>
                            <div class="exercise-toolbar">
                                <label class="stack small">
                                    <span class="muted small">{{ t('placeholders.filterExercises') }}</span>
                                    <input v-model="exerciseFilter" :placeholder="t('placeholders.filterExercises')" />
                                </label>
                                <button class="small" type="button" @click="loadExercises" :disabled="loadingExercises">
                                    {{ t('actions.refresh') }}
                                </button>
                            </div>
                        </div>
                        <div v-if="loadingExercises" class="muted small">{{ t('status.loadingExercises') }}</div>
                        <div v-else-if="exercisesError" class="muted small">{{ exercisesError }}</div>
                        <div v-else-if="filteredExercises.length===0" class="muted small">{{ t('exercises.none') }}</div>
                        <div v-else class="plan-builder-table-wrap">
                            <table class="plan-builder-table">
                                <thead>
                                <tr>
                                    <th>{{ t('labels.name') }}</th>
                                    <th>{{ t('labels.slug') }}</th>
                                    <th>{{ t('labels.difficulty') }}</th>
                                    <th>{{ t('labels.sortOrder') }}</th>
                                    <th>{{ t('labels.createdAt') }}</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr v-for="exercise in filteredExercises" :key="exercise.id">
                                    <td>
                                        <input v-model="exerciseEdits[exercise.id].name" :placeholder="t('placeholders.exerciseName')" />
                                    </td>
                                    <td>
                                        <input v-model="exerciseEdits[exercise.id].slug" :placeholder="t('placeholders.slugExample')" />
                                    </td>
                                    <td>
                                        <select v-model="exerciseEdits[exercise.id].difficulty">
                                            <option v-for="option in exerciseDifficultyOptions" :key="option" :value="option">
                                                {{ formatDifficultyLabel(option) }}
                                            </option>
                                        </select>
                                    </td>
                                    <td>
                                        <input v-model.number="exerciseEdits[exercise.id].sort_order" type="number" min="1" />
                                    </td>
                                    <td>{{ formatDate(exercise.created_at) }}</td>
                                    <td class="exercise-actions">
                                        <button
                                            class="btn"
                                            type="button"
                                            @click="saveExercise(exercise)"
                                            :disabled="exerciseSaving[exercise.id]"
                                        >
                                            {{ t('actions.save') }}
                                        </button>
                                        <button
                                            class="btn ghost"
                                            type="button"
                                            @click="deleteExercise(exercise)"
                                            :disabled="exerciseSaving[exercise.id]"
                                        >
                                            {{ t('actions.delete') }}
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-panel terminology-panel" :class="{active: activeSection==='terminology'}">
                <div class="overview-grid">
                    <div class="card">
                        <div class="overview-card-header">
                            <div class="stack">
                                <h3>{{ t('sections.terminology') }}</h3>
                                <span class="muted small">{{ t('terminology.subtitle') }}</span>
                            </div>
                            <span class="pill">{{ t('terminology.localeBadge', { locale: locale.toUpperCase() }) }}</span>
                        </div>
                        <div class="exercise-form-grid">
                            <label class="stack small">
                                <span class="muted small">{{ t('labels.termKey') }}</span>
                                <input v-model="terminologyForm.term_key" :placeholder="t('placeholders.termKeyExample')" />
                            </label>
                            <label class="stack small">
                                <span class="muted small">{{ t('labels.title') }}</span>
                                <input v-model="terminologyForm.title" :placeholder="t('placeholders.terminologyTitle')" />
                            </label>
                            <label class="stack small">
                                <span class="muted small">{{ t('labels.description') }}</span>
                                <input v-model="terminologyForm.description" :placeholder="t('placeholders.terminologyDescription')" />
                            </label>
                            <label class="stack small">
                                <span class="muted small">{{ t('labels.sortOrder') }}</span>
                                <input v-model.number="terminologyForm.sort_order" type="number" min="1" />
                            </label>
                        </div>
                        <div class="exercise-form-actions">
                            <button class="btn primary" type="button" @click="createTerminology" :disabled="creatingTerminology">
                                {{ t('actions.add') }}
                            </button>
                            <button class="btn ghost" type="button" @click="resetTerminologyForm" :disabled="creatingTerminology">
                                {{ t('actions.reset') }}
                            </button>
                            <span v-if="creatingTerminology" class="muted small">{{ t('status.savingTerminology') }}</span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="overview-card-header">
                            <div class="stack">
                                <h3>{{ t('terminology.available') }}</h3>
                                <span class="muted small">{{ t('labels.terminologyCount', { count: filteredTerminology.length }) }}</span>
                            </div>
                            <div class="exercise-toolbar">
                                <label class="stack small">
                                    <span class="muted small">{{ t('placeholders.filterTerminology') }}</span>
                                    <input v-model="terminologyFilter" :placeholder="t('placeholders.filterTerminology')" />
                                </label>
                                <button class="small" type="button" @click="loadTerminology" :disabled="loadingTerminology">
                                    {{ t('actions.refresh') }}
                                </button>
                            </div>
                        </div>
                        <div v-if="loadingTerminology" class="muted small">{{ t('status.loadingTerminology') }}</div>
                        <div v-else-if="terminologyError" class="muted small">{{ terminologyError }}</div>
                        <div v-else-if="filteredTerminology.length===0" class="muted small">{{ t('terminology.none') }}</div>
                        <div v-else class="plan-builder-table-wrap">
                            <table class="plan-builder-table">
                                <thead>
                                <tr>
                                    <th>{{ t('labels.termKey') }}</th>
                                    <th>{{ t('labels.title') }}</th>
                                    <th>{{ t('labels.description') }}</th>
                                    <th>{{ t('labels.sortOrder') }}</th>
                                    <th>{{ t('labels.createdAt') }}</th>
                                    <th></th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr v-for="entry in filteredTerminology" :key="entry.id">
                                    <td>
                                        <input v-model="terminologyEdits[entry.id].term_key" :placeholder="t('placeholders.termKeyExample')" />
                                    </td>
                                    <td>
                                        <input v-model="terminologyEdits[entry.id].title" :placeholder="t('placeholders.terminologyTitle')" />
                                    </td>
                                    <td>
                                        <input v-model="terminologyEdits[entry.id].description" :placeholder="t('placeholders.terminologyDescription')" />
                                    </td>
                                    <td>
                                        <input v-model.number="terminologyEdits[entry.id].sort_order" type="number" min="1" />
                                    </td>
                                    <td>{{ formatDate(entry.created_at) }}</td>
                                    <td class="exercise-actions">
                                        <button
                                            class="btn"
                                            type="button"
                                            @click="saveTerminology(entry)"
                                            :disabled="terminologySaving[entry.id]"
                                        >
                                            {{ t('actions.save') }}
                                        </button>
                                        <button
                                            class="btn ghost"
                                            type="button"
                                            @click="deleteTerminology(entry)"
                                            :disabled="terminologySaving[entry.id]"
                                        >
                                            {{ t('actions.delete') }}
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Vue 3 & Supabase JS v2 (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/vue@3.4.38/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
<script>
    // Fallback loader if CDNs are blocked
    (function(){
      function add(src){ var s=document.createElement('script'); s.src=src; s.crossOrigin='anonymous'; document.head.appendChild(s); }
      // Vue fallback
      window.addEventListener('error', function(){}, true);
      setTimeout(function(){
        if(!window.Vue){
          add('https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.38/vue.global.prod.min.js');
        }
        if(!window.supabase || !window.supabase.createClient){
          add('https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.45.4/supabase.min.js');
        }
      }, 300);
    })();
</script>
<script type="module" src="./supabase-bridge.js"></script>
<script type="module" src="./app.js"></script>
</body>
</html>
